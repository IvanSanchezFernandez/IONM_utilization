
# Evolution of intraoperative monitoring utilization 2006-2022








## 1. Preparation of software for analysis




Install needed packages
```{r}
# install.packages("dplyr")
library(dplyr)

# install.packages("dbplyr")
library(dbplyr)

# install.packages("tidyr")
library(tidyr)

# install.packages("RSQLite")
library(RSQLite)

# install.packages("tibble")
library(tibble)

# install.packages("haven")
library(haven)

# install.packages("lubridate")
library(lubridate)

# install.packages("gmodels")
library(gmodels)

# install.packages("bazar")
library(bazar)

# install.packages("DescTools")
library(DescTools)

# install.packages("ggplot2")
library(ggplot2)

# install.packages("plotly")
library(plotly)
```








## 2. Data ingestion




Create the connection to the database
```{r}
# Create the connection to the MarketScan database
MarketScan <- DBI::dbConnect(RSQLite::SQLite(), "D:\\MarketScan\\MarketScan.db")
src_dbi(MarketScan)
```




Create the link to the relevant tables
```{r}
# Year 2006
ms_i_2006 <- tbl(MarketScan, "ms_i_2006")
ms_s_2006 <- tbl(MarketScan, "ms_s_2006")
ms_d_2006 <- tbl(MarketScan, "ms_d_2006")
ms_o_2006 <- tbl(MarketScan, "ms_o_2006")
ms_a_2006 <- tbl(MarketScan, "ms_a_2006")
ms_t_2006 <- tbl(MarketScan, "ms_t_2006")
redbook_2006 <- tbl(MarketScan, "redbook_2006")

# Year 2007
ms_i_2007 <- tbl(MarketScan, "ms_i_2007")
ms_s_2007 <- tbl(MarketScan, "ms_s_2007")
ms_d_2007 <- tbl(MarketScan, "ms_d_2007")
ms_o_2007 <- tbl(MarketScan, "ms_o_2007")
ms_a_2007 <- tbl(MarketScan, "ms_a_2007")
ms_t_2007 <- tbl(MarketScan, "ms_t_2007")
redbook_2007 <- tbl(MarketScan, "redbook_2007")

# Year 2008
ms_i_2008 <- tbl(MarketScan, "ms_i_2008")
ms_s_2008 <- tbl(MarketScan, "ms_s_2008")
ms_d_2008 <- tbl(MarketScan, "ms_d_2008")
ms_o_2008 <- tbl(MarketScan, "ms_o_2008")
ms_a_2008 <- tbl(MarketScan, "ms_a_2008")
ms_t_2008 <- tbl(MarketScan, "ms_t_2008")
redbook_2008 <- tbl(MarketScan, "redbook_2008")

# Year 2009
ms_i_2009 <- tbl(MarketScan, "ms_i_2009")
ms_s_2009 <- tbl(MarketScan, "ms_s_2009")
ms_d_2009 <- tbl(MarketScan, "ms_d_2009")
ms_o_2009 <- tbl(MarketScan, "ms_o_2009")
ms_a_2009 <- tbl(MarketScan, "ms_a_2009")
ms_t_2009 <- tbl(MarketScan, "ms_t_2009")
redbook_2009 <- tbl(MarketScan, "redbook_2009")

# Year 2010
ms_i_2010 <- tbl(MarketScan, "ms_i_2010")
ms_s_2010 <- tbl(MarketScan, "ms_s_2010")
ms_d_2010 <- tbl(MarketScan, "ms_d_2010")
ms_o_2010 <- tbl(MarketScan, "ms_o_2010")
ms_a_2010 <- tbl(MarketScan, "ms_a_2010")
ms_t_2010 <- tbl(MarketScan, "ms_t_2010")
redbook_2010 <- tbl(MarketScan, "redbook_2010")

# Year 2011
ms_i_2011 <- tbl(MarketScan, "ms_i_2011")
ms_s_2011 <- tbl(MarketScan, "ms_s_2011")
ms_d_2011 <- tbl(MarketScan, "ms_d_2011")
ms_o_2011 <- tbl(MarketScan, "ms_o_2011")
ms_a_2011 <- tbl(MarketScan, "ms_a_2011")
ms_t_2011 <- tbl(MarketScan, "ms_t_2011")
redbook_2011 <- tbl(MarketScan, "redbook_2011")

# Year 2012
ms_i_2012 <- tbl(MarketScan, "ms_i_2012")
ms_s_2012 <- tbl(MarketScan, "ms_s_2012")
ms_d_2012 <- tbl(MarketScan, "ms_d_2012")
ms_o_2012 <- tbl(MarketScan, "ms_o_2012")
ms_a_2012 <- tbl(MarketScan, "ms_a_2012")
ms_t_2012 <- tbl(MarketScan, "ms_t_2012")
redbook_2012 <- tbl(MarketScan, "redbook_2012")

# Year 2013
ms_i_2013 <- tbl(MarketScan, "ms_i_2013")
ms_s_2013 <- tbl(MarketScan, "ms_s_2013")
ms_d_2013 <- tbl(MarketScan, "ms_d_2013")
ms_o_2013 <- tbl(MarketScan, "ms_o_2013")
ms_a_2013 <- tbl(MarketScan, "ms_a_2013")
ms_t_2013 <- tbl(MarketScan, "ms_t_2013")
redbook_2013 <- tbl(MarketScan, "redbook_2013")

# Year 2014
ms_i_2014 <- tbl(MarketScan, "ms_i_2014")
ms_s_2014 <- tbl(MarketScan, "ms_s_2014")
ms_d_2014 <- tbl(MarketScan, "ms_d_2014")
ms_o_2014 <- tbl(MarketScan, "ms_o_2014")
ms_a_2014 <- tbl(MarketScan, "ms_a_2014")
ms_t_2014 <- tbl(MarketScan, "ms_t_2014")
redbook_2014 <- tbl(MarketScan, "redbook_2014")

# Year 2015
ms_i_2015 <- tbl(MarketScan, "ms_i_2015")
ms_s_2015 <- tbl(MarketScan, "ms_s_2015")
ms_d_2015 <- tbl(MarketScan, "ms_d_2015")
ms_o_2015 <- tbl(MarketScan, "ms_o_2015")
ms_a_2015 <- tbl(MarketScan, "ms_a_2015")
ms_t_2015 <- tbl(MarketScan, "ms_t_2015")
redbook_2015 <- tbl(MarketScan, "redbook_2015")

# Year 2016
ms_i_2016 <- tbl(MarketScan, "ms_i_2016")
ms_s_2016 <- tbl(MarketScan, "ms_s_2016")
ms_d_2016 <- tbl(MarketScan, "ms_d_2016")
ms_o_2016 <- tbl(MarketScan, "ms_o_2016")
ms_a_2016 <- tbl(MarketScan, "ms_a_2016")
ms_t_2016 <- tbl(MarketScan, "ms_t_2016")
redbook_2016 <- tbl(MarketScan, "redbook_2016")

# Year 2017
ms_i_2017 <- tbl(MarketScan, "ms_i_2017")
ms_s_2017 <- tbl(MarketScan, "ms_s_2017")
ms_d_2017 <- tbl(MarketScan, "ms_d_2017")
ms_o_2017 <- tbl(MarketScan, "ms_o_2017")
ms_a_2017 <- tbl(MarketScan, "ms_a_2017")
ms_t_2017 <- tbl(MarketScan, "ms_t_2017")
redbook_2017 <- tbl(MarketScan, "redbook_2017")

# Year 2018
ms_i_2018 <- tbl(MarketScan, "ms_i_2018")
ms_s_2018 <- tbl(MarketScan, "ms_s_2018")
ms_d_2018 <- tbl(MarketScan, "ms_d_2018")
ms_o_2018 <- tbl(MarketScan, "ms_o_2018")
ms_a_2018 <- tbl(MarketScan, "ms_a_2018")
ms_t_2018 <- tbl(MarketScan, "ms_t_2018")
redbook_2018 <- tbl(MarketScan, "redbook_2018")

# Year 2019
ms_i_2019 <- tbl(MarketScan, "ms_i_2019")
ms_s_2019 <- tbl(MarketScan, "ms_s_2019")
ms_d_2019 <- tbl(MarketScan, "ms_d_2019")
ms_o_2019 <- tbl(MarketScan, "ms_o_2019")
ms_a_2019 <- tbl(MarketScan, "ms_a_2019")
ms_t_2019 <- tbl(MarketScan, "ms_t_2019")
redbook_2019 <- tbl(MarketScan, "redbook_2019")

# Year 2020
ms_i_2020 <- tbl(MarketScan, "ms_i_2020")
ms_s_2020 <- tbl(MarketScan, "ms_s_2020")
ms_d_2020 <- tbl(MarketScan, "ms_d_2020")
ms_o_2020 <- tbl(MarketScan, "ms_o_2020")
ms_a_2020 <- tbl(MarketScan, "ms_a_2020")
ms_t_2020 <- tbl(MarketScan, "ms_t_2020")
redbook_2020 <- tbl(MarketScan, "redbook_2020")

# Year 2021
ms_i_2021 <- tbl(MarketScan, "ms_i_2021")
ms_s_2021 <- tbl(MarketScan, "ms_s_2021")
ms_d_2021 <- tbl(MarketScan, "ms_d_2021")
ms_o_2021 <- tbl(MarketScan, "ms_o_2021")
ms_a_2021 <- tbl(MarketScan, "ms_a_2021")
ms_t_2021 <- tbl(MarketScan, "ms_t_2021")
redbook_2021 <- tbl(MarketScan, "redbook_2021")

# Year 2022
ms_i_2022 <- tbl(MarketScan, "ms_i_2022")
ms_s_2022 <- tbl(MarketScan, "ms_s_2022")
ms_d_2022 <- tbl(MarketScan, "ms_d_2022")
ms_o_2022 <- tbl(MarketScan, "ms_o_2022")
ms_a_2022 <- tbl(MarketScan, "ms_a_2022")
ms_t_2022 <- tbl(MarketScan, "ms_t_2022")
redbook_2022 <- tbl(MarketScan, "redbook_2022")
```








## 3. Cerebellopontine angle tumor resection




Identify patients with cerebellopontine angle tumor resection
```{r}
# Codes for patients with cerebellopontine angle tumor resection
CPT_code_cerebellopontine_angle_tumor_resection <- c("61520", "61526")




# Patients with cerebellopontine angle tumor resection

#################################2006#################################
CPA_tumor_resection_2006_s <- ms_s_2006 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_cerebellopontine_angle_tumor_resection) & (PROCTYP=="1")) %>% 
  mutate(CPA_tumor_resection_type = case_when(
    PROC1 == "61520" ~ "suboccipital",
    TRUE ~ "transmastoid")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, CPA_tumor_resection_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2007#################################
CPA_tumor_resection_2007_s <- ms_s_2007 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_cerebellopontine_angle_tumor_resection) & (PROCTYP=="1")) %>% 
  mutate(CPA_tumor_resection_type = case_when(
    PROC1 == "61520" ~ "suboccipital",
    TRUE ~ "transmastoid")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, CPA_tumor_resection_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2008#################################
CPA_tumor_resection_2008_s <- ms_s_2008 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_cerebellopontine_angle_tumor_resection) & (PROCTYP=="1")) %>% 
  mutate(CPA_tumor_resection_type = case_when(
    PROC1 == "61520" ~ "suboccipital",
    TRUE ~ "transmastoid")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, CPA_tumor_resection_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2009#################################
CPA_tumor_resection_2009_s <- ms_s_2009 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_cerebellopontine_angle_tumor_resection) & (PROCTYP=="1")) %>% 
  mutate(CPA_tumor_resection_type = case_when(
    PROC1 == "61520" ~ "suboccipital",
    TRUE ~ "transmastoid")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, CPA_tumor_resection_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2010#################################
CPA_tumor_resection_2010_s <- ms_s_2010 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_cerebellopontine_angle_tumor_resection) & (PROCTYP=="1")) %>% 
  mutate(CPA_tumor_resection_type = case_when(
    PROC1 == "61520" ~ "suboccipital",
    TRUE ~ "transmastoid")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, CPA_tumor_resection_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2011#################################
CPA_tumor_resection_2011_s <- ms_s_2011 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_cerebellopontine_angle_tumor_resection) & (PROCTYP=="1")) %>% 
  mutate(CPA_tumor_resection_type = case_when(
    PROC1 == "61520" ~ "suboccipital",
    TRUE ~ "transmastoid")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, CPA_tumor_resection_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2012#################################
CPA_tumor_resection_2012_s <- ms_s_2012 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_cerebellopontine_angle_tumor_resection) & (PROCTYP=="1")) %>% 
  mutate(CPA_tumor_resection_type = case_when(
    PROC1 == "61520" ~ "suboccipital",
    TRUE ~ "transmastoid")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, CPA_tumor_resection_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2013#################################
CPA_tumor_resection_2013_s <- ms_s_2013 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_cerebellopontine_angle_tumor_resection) & (PROCTYP=="1")) %>% 
  mutate(CPA_tumor_resection_type = case_when(
    PROC1 == "61520" ~ "suboccipital",
    TRUE ~ "transmastoid")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, CPA_tumor_resection_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2014#################################
CPA_tumor_resection_2014_s <- ms_s_2014 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_cerebellopontine_angle_tumor_resection) & (PROCTYP=="1")) %>% 
  mutate(CPA_tumor_resection_type = case_when(
    PROC1 == "61520" ~ "suboccipital",
    TRUE ~ "transmastoid")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, CPA_tumor_resection_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2015#################################
CPA_tumor_resection_2015_s <- ms_s_2015 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_cerebellopontine_angle_tumor_resection) & (PROCTYP=="1")) %>% 
  mutate(CPA_tumor_resection_type = case_when(
    PROC1 == "61520" ~ "suboccipital",
    TRUE ~ "transmastoid")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, CPA_tumor_resection_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2016#################################
CPA_tumor_resection_2016_s <- ms_s_2016 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_cerebellopontine_angle_tumor_resection) & (PROCTYP=="1")) %>% 
  mutate(CPA_tumor_resection_type = case_when(
    PROC1 == "61520" ~ "suboccipital",
    TRUE ~ "transmastoid")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, CPA_tumor_resection_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2017#################################
CPA_tumor_resection_2017_s <- ms_s_2017 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_cerebellopontine_angle_tumor_resection) & (PROCTYP=="1")) %>% 
  mutate(CPA_tumor_resection_type = case_when(
    PROC1 == "61520" ~ "suboccipital",
    TRUE ~ "transmastoid")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, CPA_tumor_resection_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2018#################################
CPA_tumor_resection_2018_s <- ms_s_2018 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_cerebellopontine_angle_tumor_resection) & (PROCTYP=="1")) %>% 
  mutate(CPA_tumor_resection_type = case_when(
    PROC1 == "61520" ~ "suboccipital",
    TRUE ~ "transmastoid")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, CPA_tumor_resection_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2019#################################
CPA_tumor_resection_2019_s <- ms_s_2019 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_cerebellopontine_angle_tumor_resection) & (PROCTYP=="1")) %>% 
  mutate(CPA_tumor_resection_type = case_when(
    PROC1 == "61520" ~ "suboccipital",
    TRUE ~ "transmastoid")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, CPA_tumor_resection_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2020#################################
CPA_tumor_resection_2020_s <- ms_s_2020 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_cerebellopontine_angle_tumor_resection) & (PROCTYP=="1")) %>% 
  mutate(CPA_tumor_resection_type = case_when(
    PROC1 == "61520" ~ "suboccipital",
    TRUE ~ "transmastoid")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, CPA_tumor_resection_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2021#################################
CPA_tumor_resection_2021_s <- ms_s_2021 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_cerebellopontine_angle_tumor_resection) & (PROCTYP=="1")) %>% 
  mutate(CPA_tumor_resection_type = case_when(
    PROC1 == "61520" ~ "suboccipital",
    TRUE ~ "transmastoid")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, CPA_tumor_resection_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2022#################################
CPA_tumor_resection_2022_s <- ms_s_2022 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_cerebellopontine_angle_tumor_resection) & (PROCTYP=="1")) %>% 
  mutate(CPA_tumor_resection_type = case_when(
    PROC1 == "61520" ~ "suboccipital",
    TRUE ~ "transmastoid")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, CPA_tumor_resection_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))




# Patients with CPA tumor resection
CPA_tumor_resection <- bind_rows(CPA_tumor_resection_2006_s, CPA_tumor_resection_2007_s, CPA_tumor_resection_2008_s, CPA_tumor_resection_2009_s, CPA_tumor_resection_2010_s, CPA_tumor_resection_2011_s, CPA_tumor_resection_2012_s, CPA_tumor_resection_2013_s, CPA_tumor_resection_2014_s, CPA_tumor_resection_2015_s, CPA_tumor_resection_2016_s, CPA_tumor_resection_2017_s, CPA_tumor_resection_2018_s, CPA_tumor_resection_2019_s, CPA_tumor_resection_2020_s, CPA_tumor_resection_2021_s, CPA_tumor_resection_2022_s) %>% 
  arrange(ENROLID, SVCDATE) %>% 
  collect()
```




Identify the monitoring of patients with cerebellopontine angle tumor resection monitoring
```{r}
# Codes for patients with brainstem auditory evoked potentials
CPT_code_BAEP <- c("92585", "92653")

# Codes for cranial nerve monitoring
CPT_code_cranial_nerve_monitoring <- c("95867", "95868", "95933")




# Patients with brainstem auditory evoked potentials or cranial nerve monitoring

#################################2006#################################
CPA_tumor_resection_BAEP_cranial_nerve_2006 <- ms_s_2006 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!CPA_tumor_resection_2006_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_BAEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_cranial_nerve_monitoring) & (PROCTYP=="1")))  %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(CPA_tumor_resection_2006_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(BAEP = case_when(
    any((PROC1 %in% CPT_code_BAEP)) ~ "BAEP", 
    TRUE ~ "no BAEP")) %>% 
  mutate(CN_monitoring = case_when(
    any((PROC1 %in% CPT_code_cranial_nerve_monitoring)) ~ "CN monitoring", 
    TRUE ~ "No CN monitoring")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, CPA_tumor_resection_type, BAEP, CN_monitoring)
  

#################################2007#################################
CPA_tumor_resection_BAEP_cranial_nerve_2007 <- ms_s_2007 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!CPA_tumor_resection_2007_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_BAEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_cranial_nerve_monitoring) & (PROCTYP=="1")))  %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(CPA_tumor_resection_2007_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(BAEP = case_when(
    any((PROC1 %in% CPT_code_BAEP)) ~ "BAEP", 
    TRUE ~ "no BAEP")) %>% 
  mutate(CN_monitoring = case_when(
    any((PROC1 %in% CPT_code_cranial_nerve_monitoring)) ~ "CN monitoring", 
    TRUE ~ "No CN monitoring")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, CPA_tumor_resection_type, BAEP, CN_monitoring)


#################################2008#################################
CPA_tumor_resection_BAEP_cranial_nerve_2008 <- ms_s_2008 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!CPA_tumor_resection_2008_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_BAEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_cranial_nerve_monitoring) & (PROCTYP=="1")))  %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(CPA_tumor_resection_2008_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(BAEP = case_when(
    any((PROC1 %in% CPT_code_BAEP)) ~ "BAEP", 
    TRUE ~ "no BAEP")) %>% 
  mutate(CN_monitoring = case_when(
    any((PROC1 %in% CPT_code_cranial_nerve_monitoring)) ~ "CN monitoring", 
    TRUE ~ "No CN monitoring")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, CPA_tumor_resection_type, BAEP, CN_monitoring)


#################################2009#################################
CPA_tumor_resection_BAEP_cranial_nerve_2009 <- ms_s_2009 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!CPA_tumor_resection_2009_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_BAEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_cranial_nerve_monitoring) & (PROCTYP=="1")))  %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(CPA_tumor_resection_2009_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(BAEP = case_when(
    any((PROC1 %in% CPT_code_BAEP)) ~ "BAEP", 
    TRUE ~ "no BAEP")) %>% 
  mutate(CN_monitoring = case_when(
    any((PROC1 %in% CPT_code_cranial_nerve_monitoring)) ~ "CN monitoring", 
    TRUE ~ "No CN monitoring")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, CPA_tumor_resection_type, BAEP, CN_monitoring)


#################################2010#################################
CPA_tumor_resection_BAEP_cranial_nerve_2010 <- ms_s_2010 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!CPA_tumor_resection_2010_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_BAEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_cranial_nerve_monitoring) & (PROCTYP=="1")))  %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(CPA_tumor_resection_2010_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(BAEP = case_when(
    any((PROC1 %in% CPT_code_BAEP)) ~ "BAEP", 
    TRUE ~ "no BAEP")) %>% 
  mutate(CN_monitoring = case_when(
    any((PROC1 %in% CPT_code_cranial_nerve_monitoring)) ~ "CN monitoring", 
    TRUE ~ "No CN monitoring")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, CPA_tumor_resection_type, BAEP, CN_monitoring)


#################################2011#################################
CPA_tumor_resection_BAEP_cranial_nerve_2011 <- ms_s_2011 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!CPA_tumor_resection_2011_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_BAEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_cranial_nerve_monitoring) & (PROCTYP=="1")))  %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(CPA_tumor_resection_2011_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(BAEP = case_when(
    any((PROC1 %in% CPT_code_BAEP)) ~ "BAEP", 
    TRUE ~ "no BAEP")) %>% 
  mutate(CN_monitoring = case_when(
    any((PROC1 %in% CPT_code_cranial_nerve_monitoring)) ~ "CN monitoring", 
    TRUE ~ "No CN monitoring")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, CPA_tumor_resection_type, BAEP, CN_monitoring)


#################################2012#################################
CPA_tumor_resection_BAEP_cranial_nerve_2012 <- ms_s_2012 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!CPA_tumor_resection_2012_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_BAEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_cranial_nerve_monitoring) & (PROCTYP=="1")))  %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(CPA_tumor_resection_2012_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(BAEP = case_when(
    any((PROC1 %in% CPT_code_BAEP)) ~ "BAEP", 
    TRUE ~ "no BAEP")) %>% 
  mutate(CN_monitoring = case_when(
    any((PROC1 %in% CPT_code_cranial_nerve_monitoring)) ~ "CN monitoring", 
    TRUE ~ "No CN monitoring")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, CPA_tumor_resection_type, BAEP, CN_monitoring)


#################################2013#################################
CPA_tumor_resection_BAEP_cranial_nerve_2013 <- ms_s_2013 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!CPA_tumor_resection_2013_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_BAEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_cranial_nerve_monitoring) & (PROCTYP=="1")))  %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(CPA_tumor_resection_2013_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(BAEP = case_when(
    any((PROC1 %in% CPT_code_BAEP)) ~ "BAEP", 
    TRUE ~ "no BAEP")) %>% 
  mutate(CN_monitoring = case_when(
    any((PROC1 %in% CPT_code_cranial_nerve_monitoring)) ~ "CN monitoring", 
    TRUE ~ "No CN monitoring")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, CPA_tumor_resection_type, BAEP, CN_monitoring)


#################################2014#################################
CPA_tumor_resection_BAEP_cranial_nerve_2014 <- ms_s_2014 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!CPA_tumor_resection_2014_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_BAEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_cranial_nerve_monitoring) & (PROCTYP=="1")))  %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(CPA_tumor_resection_2014_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(BAEP = case_when(
    any((PROC1 %in% CPT_code_BAEP)) ~ "BAEP", 
    TRUE ~ "no BAEP")) %>% 
  mutate(CN_monitoring = case_when(
    any((PROC1 %in% CPT_code_cranial_nerve_monitoring)) ~ "CN monitoring", 
    TRUE ~ "No CN monitoring")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, CPA_tumor_resection_type, BAEP, CN_monitoring)


#################################2015#################################
CPA_tumor_resection_BAEP_cranial_nerve_2015 <- ms_s_2015 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!CPA_tumor_resection_2015_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_BAEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_cranial_nerve_monitoring) & (PROCTYP=="1")))  %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(CPA_tumor_resection_2015_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(BAEP = case_when(
    any((PROC1 %in% CPT_code_BAEP)) ~ "BAEP", 
    TRUE ~ "no BAEP")) %>% 
  mutate(CN_monitoring = case_when(
    any((PROC1 %in% CPT_code_cranial_nerve_monitoring)) ~ "CN monitoring", 
    TRUE ~ "No CN monitoring")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, CPA_tumor_resection_type, BAEP, CN_monitoring)


#################################2016#################################
CPA_tumor_resection_BAEP_cranial_nerve_2016 <- ms_s_2016 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!CPA_tumor_resection_2016_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_BAEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_cranial_nerve_monitoring) & (PROCTYP=="1")))  %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(CPA_tumor_resection_2016_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(BAEP = case_when(
    any((PROC1 %in% CPT_code_BAEP)) ~ "BAEP", 
    TRUE ~ "no BAEP")) %>% 
  mutate(CN_monitoring = case_when(
    any((PROC1 %in% CPT_code_cranial_nerve_monitoring)) ~ "CN monitoring", 
    TRUE ~ "No CN monitoring")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, CPA_tumor_resection_type, BAEP, CN_monitoring)


#################################2017#################################
CPA_tumor_resection_BAEP_cranial_nerve_2017 <- ms_s_2017 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!CPA_tumor_resection_2017_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_BAEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_cranial_nerve_monitoring) & (PROCTYP=="1")))  %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(CPA_tumor_resection_2017_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(BAEP = case_when(
    any((PROC1 %in% CPT_code_BAEP)) ~ "BAEP", 
    TRUE ~ "no BAEP")) %>% 
  mutate(CN_monitoring = case_when(
    any((PROC1 %in% CPT_code_cranial_nerve_monitoring)) ~ "CN monitoring", 
    TRUE ~ "No CN monitoring")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, CPA_tumor_resection_type, BAEP, CN_monitoring)


#################################2018#################################
CPA_tumor_resection_BAEP_cranial_nerve_2018 <- ms_s_2018 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!CPA_tumor_resection_2018_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_BAEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_cranial_nerve_monitoring) & (PROCTYP=="1")))  %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(CPA_tumor_resection_2018_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(BAEP = case_when(
    any((PROC1 %in% CPT_code_BAEP)) ~ "BAEP", 
    TRUE ~ "no BAEP")) %>% 
  mutate(CN_monitoring = case_when(
    any((PROC1 %in% CPT_code_cranial_nerve_monitoring)) ~ "CN monitoring", 
    TRUE ~ "No CN monitoring")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, CPA_tumor_resection_type, BAEP, CN_monitoring)


#################################2019#################################
CPA_tumor_resection_BAEP_cranial_nerve_2019 <- ms_s_2019 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!CPA_tumor_resection_2019_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_BAEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_cranial_nerve_monitoring) & (PROCTYP=="1")))  %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(CPA_tumor_resection_2019_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(BAEP = case_when(
    any((PROC1 %in% CPT_code_BAEP)) ~ "BAEP", 
    TRUE ~ "no BAEP")) %>% 
  mutate(CN_monitoring = case_when(
    any((PROC1 %in% CPT_code_cranial_nerve_monitoring)) ~ "CN monitoring", 
    TRUE ~ "No CN monitoring")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, CPA_tumor_resection_type, BAEP, CN_monitoring)


#################################2020#################################
CPA_tumor_resection_BAEP_cranial_nerve_2020 <- ms_s_2020 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!CPA_tumor_resection_2020_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_BAEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_cranial_nerve_monitoring) & (PROCTYP=="1")))  %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(CPA_tumor_resection_2020_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(BAEP = case_when(
    any((PROC1 %in% CPT_code_BAEP)) ~ "BAEP", 
    TRUE ~ "no BAEP")) %>% 
  mutate(CN_monitoring = case_when(
    any((PROC1 %in% CPT_code_cranial_nerve_monitoring)) ~ "CN monitoring", 
    TRUE ~ "No CN monitoring")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, CPA_tumor_resection_type, BAEP, CN_monitoring)


#################################2021#################################
CPA_tumor_resection_BAEP_cranial_nerve_2021 <- ms_s_2021 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!CPA_tumor_resection_2021_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_BAEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_cranial_nerve_monitoring) & (PROCTYP=="1")))  %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(CPA_tumor_resection_2021_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(BAEP = case_when(
    any((PROC1 %in% CPT_code_BAEP)) ~ "BAEP", 
    TRUE ~ "no BAEP")) %>% 
  mutate(CN_monitoring = case_when(
    any((PROC1 %in% CPT_code_cranial_nerve_monitoring)) ~ "CN monitoring", 
    TRUE ~ "No CN monitoring")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, CPA_tumor_resection_type, BAEP, CN_monitoring)


#################################2022#################################
CPA_tumor_resection_BAEP_cranial_nerve_2022 <- ms_s_2022 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!CPA_tumor_resection_2022_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_BAEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_cranial_nerve_monitoring) & (PROCTYP=="1")))  %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(CPA_tumor_resection_2022_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(BAEP = case_when(
    any((PROC1 %in% CPT_code_BAEP)) ~ "BAEP", 
    TRUE ~ "no BAEP")) %>% 
  mutate(CN_monitoring = case_when(
    any((PROC1 %in% CPT_code_cranial_nerve_monitoring)) ~ "CN monitoring", 
    TRUE ~ "No CN monitoring")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, CPA_tumor_resection_type, BAEP, CN_monitoring)




# Patients with CPA tumor resection with or without BAEP and cranial nerve monitoring
CPA_tumor_resection_BAEP_cranial_nerve <- bind_rows(CPA_tumor_resection_BAEP_cranial_nerve_2006, CPA_tumor_resection_BAEP_cranial_nerve_2007, CPA_tumor_resection_BAEP_cranial_nerve_2008, CPA_tumor_resection_BAEP_cranial_nerve_2009, CPA_tumor_resection_BAEP_cranial_nerve_2010, CPA_tumor_resection_BAEP_cranial_nerve_2011, CPA_tumor_resection_BAEP_cranial_nerve_2012, CPA_tumor_resection_BAEP_cranial_nerve_2013, CPA_tumor_resection_BAEP_cranial_nerve_2014, CPA_tumor_resection_BAEP_cranial_nerve_2015, CPA_tumor_resection_BAEP_cranial_nerve_2016, CPA_tumor_resection_BAEP_cranial_nerve_2017, CPA_tumor_resection_BAEP_cranial_nerve_2018, CPA_tumor_resection_BAEP_cranial_nerve_2019, CPA_tumor_resection_BAEP_cranial_nerve_2020, CPA_tumor_resection_BAEP_cranial_nerve_2021, CPA_tumor_resection_BAEP_cranial_nerve_2022) %>% 
  arrange(ENROLID, SVCDATE) %>% 
  collect()
```




Cerebellopontine angle demographics
```{r}
#################################2006#################################
CPA_tumor_resection_demographics_2006 <- ms_t_2006 %>% 
  filter(ENROLID %in% !!CPA_tumor_resection_BAEP_cranial_nerve$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2007#################################
CPA_tumor_resection_demographics_2007 <- ms_t_2007 %>% 
  filter(ENROLID %in% !!CPA_tumor_resection_BAEP_cranial_nerve$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2008#################################
CPA_tumor_resection_demographics_2008 <- ms_t_2008 %>% 
  filter(ENROLID %in% !!CPA_tumor_resection_BAEP_cranial_nerve$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2009#################################
CPA_tumor_resection_demographics_2009 <- ms_t_2009 %>% 
  filter(ENROLID %in% !!CPA_tumor_resection_BAEP_cranial_nerve$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2010#################################
CPA_tumor_resection_demographics_2010 <- ms_t_2010 %>% 
  filter(ENROLID %in% !!CPA_tumor_resection_BAEP_cranial_nerve$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2011#################################
CPA_tumor_resection_demographics_2011 <- ms_t_2011 %>% 
  filter(ENROLID %in% !!CPA_tumor_resection_BAEP_cranial_nerve$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2012#################################
CPA_tumor_resection_demographics_2012 <- ms_t_2012 %>% 
  filter(ENROLID %in% !!CPA_tumor_resection_BAEP_cranial_nerve$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2013#################################
CPA_tumor_resection_demographics_2013 <- ms_t_2013 %>% 
  filter(ENROLID %in% !!CPA_tumor_resection_BAEP_cranial_nerve$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2014#################################
CPA_tumor_resection_demographics_2014 <- ms_t_2014 %>% 
  filter(ENROLID %in% !!CPA_tumor_resection_BAEP_cranial_nerve$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2015#################################
CPA_tumor_resection_demographics_2015 <- ms_t_2015 %>% 
  filter(ENROLID %in% !!CPA_tumor_resection_BAEP_cranial_nerve$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2016#################################
CPA_tumor_resection_demographics_2016 <- ms_t_2016 %>% 
  filter(ENROLID %in% !!CPA_tumor_resection_BAEP_cranial_nerve$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2017#################################
CPA_tumor_resection_demographics_2017 <- ms_t_2017 %>% 
  filter(ENROLID %in% !!CPA_tumor_resection_BAEP_cranial_nerve$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2018#################################
CPA_tumor_resection_demographics_2018 <- ms_t_2018 %>% 
  filter(ENROLID %in% !!CPA_tumor_resection_BAEP_cranial_nerve$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2019#################################
CPA_tumor_resection_demographics_2019 <- ms_t_2019 %>% 
  filter(ENROLID %in% !!CPA_tumor_resection_BAEP_cranial_nerve$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2020#################################
CPA_tumor_resection_demographics_2020 <- ms_t_2020 %>% 
  filter(ENROLID %in% !!CPA_tumor_resection_BAEP_cranial_nerve$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2021#################################
CPA_tumor_resection_demographics_2021 <- ms_t_2021 %>% 
  filter(ENROLID %in% !!CPA_tumor_resection_BAEP_cranial_nerve$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2022#################################
CPA_tumor_resection_demographics_2022 <- ms_t_2022 %>% 
  filter(ENROLID %in% !!CPA_tumor_resection_BAEP_cranial_nerve$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()




# Demographics
CPA_tumor_resection_demographics <- bind_rows(CPA_tumor_resection_demographics_2006, CPA_tumor_resection_demographics_2007, CPA_tumor_resection_demographics_2008, CPA_tumor_resection_demographics_2009, CPA_tumor_resection_demographics_2010, CPA_tumor_resection_demographics_2011, CPA_tumor_resection_demographics_2012, CPA_tumor_resection_demographics_2013, CPA_tumor_resection_demographics_2014, CPA_tumor_resection_demographics_2015, CPA_tumor_resection_demographics_2016, CPA_tumor_resection_demographics_2017, CPA_tumor_resection_demographics_2018, CPA_tumor_resection_demographics_2019, CPA_tumor_resection_demographics_2020, CPA_tumor_resection_demographics_2021, CPA_tumor_resection_demographics_2022) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  arrange(ENROLID, DTSTART) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  select(ENROLID, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, INDSTRY, MSA) %>% 
  collect()
```




Add demographic data to the database
```{r}
# Add demographic data to the database
CPA_tumor_resection_BAEP_cranial_nerve_demographics <- CPA_tumor_resection_BAEP_cranial_nerve %>% 
  left_join(CPA_tumor_resection_demographics, by="ENROLID") %>% 
  mutate(any_monitoring = as.factor(case_when(
    (BAEP == "BAEP" | CN_monitoring == "CN monitoring") ~ "monitoring",
    TRUE ~ "no monitoring"))) %>% 
  mutate(male = as.factor(case_when(
  SEX == 1 ~ "yes",
  TRUE ~ "no"))) %>% 
  mutate(year_surgery = case_when(
  (year(SVCDATE) %in% 2006:2011) ~ "2006-2011",
  (year(SVCDATE) %in% 2012:2017) ~ "2012-2017",
  (year(SVCDATE) %in% 2018:2022) ~ "2018-2022")) %>% 
  mutate(rural = as.factor(case_when(
  MSA == 0 ~ "yes",
  TRUE ~ "no"))) %>% 
  mutate(region_category = as.factor(case_when(
  REGION == 1 ~ "Northeast",
  REGION == 2 ~ "North Central",
  REGION == 3 ~ "South",
  REGION == 4 ~ "West",
  TRUE ~ "unknown"))) %>% 
  mutate(employment_status_category = as.factor(case_when(
  EESTATU == 1 ~ "full-time",
  TRUE ~ "other"))) %>% 
  mutate(employment_class_category = as.factor(case_when(
  (EECLASS == 1 | EECLASS == 2 | EECLASS == 3) ~ "salary",
  (EECLASS == 4 | EECLASS == 5 | EECLASS == 6) ~ "hourly",
  TRUE ~ "other"))) %>% 
  mutate(any_monitoring_numeric = case_when(
    any_monitoring == "monitoring" ~ 1,
    TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, any_monitoring, any_monitoring_numeric, AGE, male, year_surgery, rural, region_category, employment_class_category, employment_status_category, CPA_tumor_resection_type, BAEP, CN_monitoring)
```




Demographics cerebellopontine angle tumor resection
```{r}
# Total surgeries
CPA_tumor_resection_total_surgeries <- CPA_tumor_resection_BAEP_cranial_nerve_demographics %>% 
  nrow()
CPA_tumor_resection_total_surgeries


# Total patients
CPA_tumor_resection_total_patients <- CPA_tumor_resection_BAEP_cranial_nerve_demographics %>% 
  distinct(ENROLID) %>% 
  nrow()
CPA_tumor_resection_total_patients


# Age
CPA_tumor_resection_age <- CPA_tumor_resection_BAEP_cranial_nerve_demographics %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  summarize(
    median_age = median(AGE),
    p25_age = quantile(AGE, 0.25),
    p75_age = quantile(AGE, 0.75),
    mean_age = mean(AGE),
    SD_age = sd(AGE)
  ) %>% 
  collect()
CPA_tumor_resection_age


# Sex
CPA_tumor_resection_sex <- CPA_tumor_resection_BAEP_cranial_nerve_demographics %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  reframe(
  sex = CrossTable(male)
)


# Year surgery
CPA_tumor_resection_year_surgery <- CPA_tumor_resection_BAEP_cranial_nerve_demographics %>% 
  reframe(
  year_surgery = CrossTable(year_surgery)
)


# Rural
CPA_tumor_resection_rural <- CPA_tumor_resection_BAEP_cranial_nerve_demographics %>% 
  reframe(
  rural = CrossTable(rural)
)


# Region
CPA_tumor_resection_region <- CPA_tumor_resection_BAEP_cranial_nerve_demographics %>% 
  reframe(
  region = CrossTable(region_category)
)


# Employment status
CPA_tumor_resection_employment_status <- CPA_tumor_resection_BAEP_cranial_nerve_demographics %>% 
  reframe(
  employment_status = CrossTable(employment_status_category)
)


# Employment class
CPA_tumor_resection_employment_class <- CPA_tumor_resection_BAEP_cranial_nerve_demographics %>% 
  reframe(
  employment_class = CrossTable(employment_class_category)
)
```




Cerebellopontine angle tumor resection monitoring
```{r}
# Cerebellopontine angle tumor resection type
CPA_tumor_resection_surgery_type <- CPA_tumor_resection_BAEP_cranial_nerve_demographics %>% 
  reframe(
  surgery_type = CrossTable(CPA_tumor_resection_type)
)


# Cerebellopontine angle tumor resection monitoring
CPA_tumor_resection_monitoring_results <- CPA_tumor_resection_BAEP_cranial_nerve_demographics %>% 
  reframe(
  BAEP_CP_monitoring = CrossTable(BAEP, CN_monitoring)
)


# Regression on cerebellopontine angle tumor resection monitoring 
CPA_tumor_resection_logistic_regression <- glm(any_monitoring_numeric ~ AGE + male +  year_surgery + CPA_tumor_resection_type + rural + relevel(region_category, ref="West") + relevel(employment_status_category, ref="other") + relevel(employment_class_category, ref="hourly"), data = CPA_tumor_resection_BAEP_cranial_nerve_demographics, family = "binomial")

summary(CPA_tumor_resection_logistic_regression)

exp(cbind(OR=coef(CPA_tumor_resection_logistic_regression), confint(CPA_tumor_resection_logistic_regression)))
```




Cerebellopontine angle tumor resection by year
```{r}
# Cerebellopontine angle tumor resection monitoring by year
CPA_tumor_resection_monitoring_results_by_year <- CPA_tumor_resection_BAEP_cranial_nerve_demographics %>% 
  group_by(year(SVCDATE)) %>% 
  reframe(
  BAEP_CP_monitoring = CrossTable(BAEP, CN_monitoring)
)


CPA_tumor_resection_monitoring_results_by_year_database <- CPA_tumor_resection_BAEP_cranial_nerve_demographics %>% 
  mutate(
    number_any_monitoring = case_when(
      any_monitoring == "monitoring" ~ 1,
      TRUE ~ 0),
    number_BAEP = case_when(
      BAEP == "BAEP" ~ 1,
      TRUE ~ 0),
    number_CN_monitoring = case_when(
      CN_monitoring == "CN monitoring" ~ 1,
      TRUE ~ 0)      
  ) %>% 
  group_by(year(SVCDATE)) %>% 
  summarize(
    count_any_monitoring = sum(number_any_monitoring),
    proportion_any_monitoring = count_any_monitoring / n(),
    count_BAEP = sum(number_BAEP),
    proportion_BAEP = count_BAEP / n(),
    count_CN_monitoring = sum(number_CN_monitoring),
    proportion_CN_monitoring = count_CN_monitoring / n()   
  ) %>% 
  collect()
CPA_tumor_resection_monitoring_results_by_year_database


# Proportion of patients with monitoring per year figure
CPA_tumor_resection_monitoring_results_by_year_plot <- ggplot(data=CPA_tumor_resection_monitoring_results_by_year_database) +
  geom_line(aes(x=`year(SVCDATE)`, y=proportion_any_monitoring), lwd=1.5, color="darkgreen") +   
  geom_line(aes(x=`year(SVCDATE)`, y=proportion_BAEP), lwd=1.5, color="red") + 
  geom_line(aes(x=`year(SVCDATE)`, y=proportion_CN_monitoring), lwd=1.5, color="blue") + 
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2022) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 1, 0.1), limits = c(0, 1))
CPA_tumor_resection_monitoring_results_by_year_plot
```








## 4. Carotid endarterectomy




Identify patients with carotid endarterectomy
```{r}
# Codes for patients with carotid endarterectomy
CPT_code_carotid_endarterectomy <- c("35301", "35390")




# Patients with carotid endarterectomy

#################################2006#################################
carotid_endarterectomy_2006_s <- ms_s_2006 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_carotid_endarterectomy) & (PROCTYP=="1")) %>% 
  mutate(carotid_endarterectomy_type = case_when(
    PROC1 == "35390" ~ "reoperation",
    TRUE ~ "no reoperation")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, carotid_endarterectomy_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2007#################################
carotid_endarterectomy_2007_s <- ms_s_2007 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_carotid_endarterectomy) & (PROCTYP=="1")) %>% 
  mutate(carotid_endarterectomy_type = case_when(
    PROC1 == "35390" ~ "reoperation",
    TRUE ~ "no reoperation")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, carotid_endarterectomy_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2008#################################
carotid_endarterectomy_2008_s <- ms_s_2008 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_carotid_endarterectomy) & (PROCTYP=="1")) %>% 
  mutate(carotid_endarterectomy_type = case_when(
    PROC1 == "35390" ~ "reoperation",
    TRUE ~ "no reoperation")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, carotid_endarterectomy_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2009#################################
carotid_endarterectomy_2009_s <- ms_s_2009 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_carotid_endarterectomy) & (PROCTYP=="1")) %>% 
  mutate(carotid_endarterectomy_type = case_when(
    PROC1 == "35390" ~ "reoperation",
    TRUE ~ "no reoperation")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, carotid_endarterectomy_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2010#################################
carotid_endarterectomy_2010_s <- ms_s_2010 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_carotid_endarterectomy) & (PROCTYP=="1")) %>% 
  mutate(carotid_endarterectomy_type = case_when(
    PROC1 == "35390" ~ "reoperation",
    TRUE ~ "no reoperation")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, carotid_endarterectomy_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2011#################################
carotid_endarterectomy_2011_s <- ms_s_2011 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_carotid_endarterectomy) & (PROCTYP=="1")) %>% 
  mutate(carotid_endarterectomy_type = case_when(
    PROC1 == "35390" ~ "reoperation",
    TRUE ~ "no reoperation")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, carotid_endarterectomy_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2012#################################
carotid_endarterectomy_2012_s <- ms_s_2012 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_carotid_endarterectomy) & (PROCTYP=="1")) %>% 
  mutate(carotid_endarterectomy_type = case_when(
    PROC1 == "35390" ~ "reoperation",
    TRUE ~ "no reoperation")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, carotid_endarterectomy_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2013#################################
carotid_endarterectomy_2013_s <- ms_s_2013 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_carotid_endarterectomy) & (PROCTYP=="1")) %>% 
  mutate(carotid_endarterectomy_type = case_when(
    PROC1 == "35390" ~ "reoperation",
    TRUE ~ "no reoperation")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, carotid_endarterectomy_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2014#################################
carotid_endarterectomy_2014_s <- ms_s_2014 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_carotid_endarterectomy) & (PROCTYP=="1")) %>% 
  mutate(carotid_endarterectomy_type = case_when(
    PROC1 == "35390" ~ "reoperation",
    TRUE ~ "no reoperation")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, carotid_endarterectomy_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2015#################################
carotid_endarterectomy_2015_s <- ms_s_2015 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_carotid_endarterectomy) & (PROCTYP=="1")) %>% 
  mutate(carotid_endarterectomy_type = case_when(
    PROC1 == "35390" ~ "reoperation",
    TRUE ~ "no reoperation")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, carotid_endarterectomy_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2016#################################
carotid_endarterectomy_2016_s <- ms_s_2016 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_carotid_endarterectomy) & (PROCTYP=="1")) %>% 
  mutate(carotid_endarterectomy_type = case_when(
    PROC1 == "35390" ~ "reoperation",
    TRUE ~ "no reoperation")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, carotid_endarterectomy_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2017#################################
carotid_endarterectomy_2017_s <- ms_s_2017 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_carotid_endarterectomy) & (PROCTYP=="1")) %>% 
  mutate(carotid_endarterectomy_type = case_when(
    PROC1 == "35390" ~ "reoperation",
    TRUE ~ "no reoperation")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, carotid_endarterectomy_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2018#################################
carotid_endarterectomy_2018_s <- ms_s_2018 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_carotid_endarterectomy) & (PROCTYP=="1")) %>% 
  mutate(carotid_endarterectomy_type = case_when(
    PROC1 == "35390" ~ "reoperation",
    TRUE ~ "no reoperation")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, carotid_endarterectomy_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2019#################################
carotid_endarterectomy_2019_s <- ms_s_2019 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_carotid_endarterectomy) & (PROCTYP=="1")) %>% 
  mutate(carotid_endarterectomy_type = case_when(
    PROC1 == "35390" ~ "reoperation",
    TRUE ~ "no reoperation")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, carotid_endarterectomy_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2020#################################
carotid_endarterectomy_2020_s <- ms_s_2020 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_carotid_endarterectomy) & (PROCTYP=="1")) %>% 
  mutate(carotid_endarterectomy_type = case_when(
    PROC1 == "35390" ~ "reoperation",
    TRUE ~ "no reoperation")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, carotid_endarterectomy_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2021#################################
carotid_endarterectomy_2021_s <- ms_s_2021 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_carotid_endarterectomy) & (PROCTYP=="1")) %>% 
  mutate(carotid_endarterectomy_type = case_when(
    PROC1 == "35390" ~ "reoperation",
    TRUE ~ "no reoperation")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, carotid_endarterectomy_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2022#################################
carotid_endarterectomy_2022_s <- ms_s_2022 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_carotid_endarterectomy) & (PROCTYP=="1")) %>% 
  mutate(carotid_endarterectomy_type = case_when(
    PROC1 == "35390" ~ "reoperation",
    TRUE ~ "no reoperation")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, carotid_endarterectomy_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))




# Patients with carotid endarterectomy
carotid_endarterectomy <- bind_rows(carotid_endarterectomy_2006_s, carotid_endarterectomy_2007_s, carotid_endarterectomy_2008_s, carotid_endarterectomy_2009_s, carotid_endarterectomy_2010_s, carotid_endarterectomy_2011_s, carotid_endarterectomy_2012_s, carotid_endarterectomy_2013_s, carotid_endarterectomy_2014_s, carotid_endarterectomy_2015_s, carotid_endarterectomy_2016_s, carotid_endarterectomy_2017_s, carotid_endarterectomy_2018_s, carotid_endarterectomy_2019_s, carotid_endarterectomy_2020_s, carotid_endarterectomy_2021_s, carotid_endarterectomy_2022_s) %>% 
  arrange(ENROLID, SVCDATE) %>% 
  collect()
```




Identify the monitoring of patients with carotid endarterectomy monitoring
```{r}
# Codes for patients with EEG monitoring
CPT_code_EEG <- c("95707", "95709", "95710", "95712", "95713", "95715", "95716", "95717", "95718", "95719", "95720", "95721", "95722", "95723", "95724", "95725", "95726", "95812", "95813", "95816", "95819", "95822", "95955")

# Codes for somatosensory evoked potentials
CPT_code_SSEP <- c("95925", "95926", "95927", "95938")




# Patients with electroencephalogram or somatosensory evoked potentials monitoring

#################################2006#################################
carotid_endarterectomy_EEG_SSEP_2006 <- ms_s_2006 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!carotid_endarterectomy_2006_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_EEG) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")))  %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(carotid_endarterectomy_2006_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(EEG_monitoring = case_when(
    any((PROC1 %in% CPT_code_EEG)) ~ "EEG", 
    TRUE ~ "no EEG")) %>% 
  mutate(SSEP_monitoring = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "No SSEP")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, carotid_endarterectomy_type, EEG_monitoring, SSEP_monitoring)
  

#################################2007#################################
carotid_endarterectomy_EEG_SSEP_2007 <- ms_s_2007 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!carotid_endarterectomy_2007_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_EEG) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")))  %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(carotid_endarterectomy_2007_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(EEG_monitoring = case_when(
    any((PROC1 %in% CPT_code_EEG)) ~ "EEG", 
    TRUE ~ "no EEG")) %>% 
  mutate(SSEP_monitoring = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "No SSEP")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, carotid_endarterectomy_type, EEG_monitoring, SSEP_monitoring)


#################################2008#################################
carotid_endarterectomy_EEG_SSEP_2008 <- ms_s_2008 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!carotid_endarterectomy_2008_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_EEG) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")))  %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(carotid_endarterectomy_2008_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(EEG_monitoring = case_when(
    any((PROC1 %in% CPT_code_EEG)) ~ "EEG", 
    TRUE ~ "no EEG")) %>% 
  mutate(SSEP_monitoring = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "No SSEP")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, carotid_endarterectomy_type, EEG_monitoring, SSEP_monitoring)


#################################2009#################################
carotid_endarterectomy_EEG_SSEP_2009 <- ms_s_2009 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!carotid_endarterectomy_2009_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_EEG) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")))  %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(carotid_endarterectomy_2009_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(EEG_monitoring = case_when(
    any((PROC1 %in% CPT_code_EEG)) ~ "EEG", 
    TRUE ~ "no EEG")) %>% 
  mutate(SSEP_monitoring = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "No SSEP")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, carotid_endarterectomy_type, EEG_monitoring, SSEP_monitoring)


#################################2010#################################
carotid_endarterectomy_EEG_SSEP_2010 <- ms_s_2010 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!carotid_endarterectomy_2010_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_EEG) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")))  %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(carotid_endarterectomy_2010_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(EEG_monitoring = case_when(
    any((PROC1 %in% CPT_code_EEG)) ~ "EEG", 
    TRUE ~ "no EEG")) %>% 
  mutate(SSEP_monitoring = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "No SSEP")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, carotid_endarterectomy_type, EEG_monitoring, SSEP_monitoring)


#################################2011#################################
carotid_endarterectomy_EEG_SSEP_2011 <- ms_s_2011 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!carotid_endarterectomy_2011_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_EEG) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")))  %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(carotid_endarterectomy_2011_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(EEG_monitoring = case_when(
    any((PROC1 %in% CPT_code_EEG)) ~ "EEG", 
    TRUE ~ "no EEG")) %>% 
  mutate(SSEP_monitoring = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "No SSEP")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, carotid_endarterectomy_type, EEG_monitoring, SSEP_monitoring)


#################################2012#################################
carotid_endarterectomy_EEG_SSEP_2012 <- ms_s_2012 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!carotid_endarterectomy_2012_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_EEG) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")))  %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(carotid_endarterectomy_2012_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(EEG_monitoring = case_when(
    any((PROC1 %in% CPT_code_EEG)) ~ "EEG", 
    TRUE ~ "no EEG")) %>% 
  mutate(SSEP_monitoring = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "No SSEP")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, carotid_endarterectomy_type, EEG_monitoring, SSEP_monitoring)


#################################2013#################################
carotid_endarterectomy_EEG_SSEP_2013 <- ms_s_2013 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!carotid_endarterectomy_2013_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_EEG) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")))  %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(carotid_endarterectomy_2013_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(EEG_monitoring = case_when(
    any((PROC1 %in% CPT_code_EEG)) ~ "EEG", 
    TRUE ~ "no EEG")) %>% 
  mutate(SSEP_monitoring = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "No SSEP")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, carotid_endarterectomy_type, EEG_monitoring, SSEP_monitoring)


#################################2014#################################
carotid_endarterectomy_EEG_SSEP_2014 <- ms_s_2014 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!carotid_endarterectomy_2014_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_EEG) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")))  %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(carotid_endarterectomy_2014_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(EEG_monitoring = case_when(
    any((PROC1 %in% CPT_code_EEG)) ~ "EEG", 
    TRUE ~ "no EEG")) %>% 
  mutate(SSEP_monitoring = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "No SSEP")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, carotid_endarterectomy_type, EEG_monitoring, SSEP_monitoring)


#################################2015#################################
carotid_endarterectomy_EEG_SSEP_2015 <- ms_s_2015 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!carotid_endarterectomy_2015_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_EEG) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")))  %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(carotid_endarterectomy_2015_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(EEG_monitoring = case_when(
    any((PROC1 %in% CPT_code_EEG)) ~ "EEG", 
    TRUE ~ "no EEG")) %>% 
  mutate(SSEP_monitoring = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "No SSEP")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, carotid_endarterectomy_type, EEG_monitoring, SSEP_monitoring)


#################################2016#################################
carotid_endarterectomy_EEG_SSEP_2016 <- ms_s_2016 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!carotid_endarterectomy_2016_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_EEG) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")))  %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(carotid_endarterectomy_2016_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(EEG_monitoring = case_when(
    any((PROC1 %in% CPT_code_EEG)) ~ "EEG", 
    TRUE ~ "no EEG")) %>% 
  mutate(SSEP_monitoring = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "No SSEP")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, carotid_endarterectomy_type, EEG_monitoring, SSEP_monitoring)


#################################2017#################################
carotid_endarterectomy_EEG_SSEP_2017 <- ms_s_2017 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!carotid_endarterectomy_2017_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_EEG) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")))  %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(carotid_endarterectomy_2017_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(EEG_monitoring = case_when(
    any((PROC1 %in% CPT_code_EEG)) ~ "EEG", 
    TRUE ~ "no EEG")) %>% 
  mutate(SSEP_monitoring = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "No SSEP")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, carotid_endarterectomy_type, EEG_monitoring, SSEP_monitoring)


#################################2018#################################
carotid_endarterectomy_EEG_SSEP_2018 <- ms_s_2018 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!carotid_endarterectomy_2018_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_EEG) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")))  %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(carotid_endarterectomy_2018_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(EEG_monitoring = case_when(
    any((PROC1 %in% CPT_code_EEG)) ~ "EEG", 
    TRUE ~ "no EEG")) %>% 
  mutate(SSEP_monitoring = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "No SSEP")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, carotid_endarterectomy_type, EEG_monitoring, SSEP_monitoring)


#################################2019#################################
carotid_endarterectomy_EEG_SSEP_2019 <- ms_s_2019 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!carotid_endarterectomy_2019_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_EEG) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")))  %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(carotid_endarterectomy_2019_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(EEG_monitoring = case_when(
    any((PROC1 %in% CPT_code_EEG)) ~ "EEG", 
    TRUE ~ "no EEG")) %>% 
  mutate(SSEP_monitoring = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "No SSEP")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, carotid_endarterectomy_type, EEG_monitoring, SSEP_monitoring)


#################################2020#################################
carotid_endarterectomy_EEG_SSEP_2020 <- ms_s_2020 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!carotid_endarterectomy_2020_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_EEG) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")))  %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(carotid_endarterectomy_2020_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(EEG_monitoring = case_when(
    any((PROC1 %in% CPT_code_EEG)) ~ "EEG", 
    TRUE ~ "no EEG")) %>% 
  mutate(SSEP_monitoring = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "No SSEP")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, carotid_endarterectomy_type, EEG_monitoring, SSEP_monitoring)


#################################2021#################################
carotid_endarterectomy_EEG_SSEP_2021 <- ms_s_2021 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!carotid_endarterectomy_2021_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_EEG) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")))  %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(carotid_endarterectomy_2021_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(EEG_monitoring = case_when(
    any((PROC1 %in% CPT_code_EEG)) ~ "EEG", 
    TRUE ~ "no EEG")) %>% 
  mutate(SSEP_monitoring = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "No SSEP")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, carotid_endarterectomy_type, EEG_monitoring, SSEP_monitoring)


#################################2022#################################
carotid_endarterectomy_EEG_SSEP_2022 <- ms_s_2022 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!carotid_endarterectomy_2022_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_EEG) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")))  %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(carotid_endarterectomy_2022_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(EEG_monitoring = case_when(
    any((PROC1 %in% CPT_code_EEG)) ~ "EEG", 
    TRUE ~ "no EEG")) %>% 
  mutate(SSEP_monitoring = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "No SSEP")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, carotid_endarterectomy_type, EEG_monitoring, SSEP_monitoring)




# Patients with carotid endarterectomy with or without electroencephalogram and somatosensory evoked potentials
carotid_endarterectomy_EEG_SSEP <- bind_rows(carotid_endarterectomy_EEG_SSEP_2006, carotid_endarterectomy_EEG_SSEP_2007, carotid_endarterectomy_EEG_SSEP_2008, carotid_endarterectomy_EEG_SSEP_2009, carotid_endarterectomy_EEG_SSEP_2010, carotid_endarterectomy_EEG_SSEP_2011, carotid_endarterectomy_EEG_SSEP_2012, carotid_endarterectomy_EEG_SSEP_2013, carotid_endarterectomy_EEG_SSEP_2014, carotid_endarterectomy_EEG_SSEP_2015, carotid_endarterectomy_EEG_SSEP_2016, carotid_endarterectomy_EEG_SSEP_2017, carotid_endarterectomy_EEG_SSEP_2018, carotid_endarterectomy_EEG_SSEP_2019, carotid_endarterectomy_EEG_SSEP_2020, carotid_endarterectomy_EEG_SSEP_2021, carotid_endarterectomy_EEG_SSEP_2022) %>% 
  arrange(ENROLID, SVCDATE) %>% 
  collect()
```




Carotid endarterectomy demographics
```{r}
#################################2006#################################
carotid_endarterectomy_demographics_2006 <- ms_t_2006 %>% 
  filter(ENROLID %in% !!carotid_endarterectomy_EEG_SSEP$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% collect()


#################################2007#################################
carotid_endarterectomy_demographics_2007 <- ms_t_2007 %>% 
  filter(ENROLID %in% !!carotid_endarterectomy_EEG_SSEP$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% collect()


#################################2008#################################
carotid_endarterectomy_demographics_2008 <- ms_t_2008 %>% 
  filter(ENROLID %in% !!carotid_endarterectomy_EEG_SSEP$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% collect()


#################################2009#################################
carotid_endarterectomy_demographics_2009 <- ms_t_2009 %>% 
  filter(ENROLID %in% !!carotid_endarterectomy_EEG_SSEP$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% collect()


#################################2010#################################
carotid_endarterectomy_demographics_2010 <- ms_t_2010 %>% 
  filter(ENROLID %in% !!carotid_endarterectomy_EEG_SSEP$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% collect()


#################################2011#################################
carotid_endarterectomy_demographics_2011 <- ms_t_2011 %>% 
  filter(ENROLID %in% !!carotid_endarterectomy_EEG_SSEP$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% collect()


#################################2012#################################
carotid_endarterectomy_demographics_2012 <- ms_t_2012 %>% 
  filter(ENROLID %in% !!carotid_endarterectomy_EEG_SSEP$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% collect()


#################################2013#################################
carotid_endarterectomy_demographics_2013 <- ms_t_2013 %>% 
  filter(ENROLID %in% !!carotid_endarterectomy_EEG_SSEP$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% collect()


#################################2014#################################
carotid_endarterectomy_demographics_2014 <- ms_t_2014 %>% 
  filter(ENROLID %in% !!carotid_endarterectomy_EEG_SSEP$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% collect()


#################################2015#################################
carotid_endarterectomy_demographics_2015 <- ms_t_2015 %>% 
  filter(ENROLID %in% !!carotid_endarterectomy_EEG_SSEP$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% collect()


#################################2016#################################
carotid_endarterectomy_demographics_2016 <- ms_t_2016 %>% 
  filter(ENROLID %in% !!carotid_endarterectomy_EEG_SSEP$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% collect()


#################################2017#################################
carotid_endarterectomy_demographics_2017 <- ms_t_2017 %>% 
  filter(ENROLID %in% !!carotid_endarterectomy_EEG_SSEP$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% collect()


#################################2018#################################
carotid_endarterectomy_demographics_2018 <- ms_t_2018 %>% 
  filter(ENROLID %in% !!carotid_endarterectomy_EEG_SSEP$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% collect()


#################################2019#################################
carotid_endarterectomy_demographics_2019 <- ms_t_2019 %>% 
  filter(ENROLID %in% !!carotid_endarterectomy_EEG_SSEP$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% collect()


#################################2020#################################
carotid_endarterectomy_demographics_2020 <- ms_t_2020 %>% 
  filter(ENROLID %in% !!carotid_endarterectomy_EEG_SSEP$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% collect()


#################################2021#################################
carotid_endarterectomy_demographics_2021 <- ms_t_2021 %>% 
  filter(ENROLID %in% !!carotid_endarterectomy_EEG_SSEP$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% collect()


#################################2022#################################
carotid_endarterectomy_demographics_2022 <- ms_t_2022 %>% 
  filter(ENROLID %in% !!carotid_endarterectomy_EEG_SSEP$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% collect()




# Demographics
carotid_endarterectomy_demographics <- bind_rows(carotid_endarterectomy_demographics_2006, carotid_endarterectomy_demographics_2007, carotid_endarterectomy_demographics_2008, carotid_endarterectomy_demographics_2009, carotid_endarterectomy_demographics_2010, carotid_endarterectomy_demographics_2011, carotid_endarterectomy_demographics_2012, carotid_endarterectomy_demographics_2013, carotid_endarterectomy_demographics_2014, carotid_endarterectomy_demographics_2015, carotid_endarterectomy_demographics_2016, carotid_endarterectomy_demographics_2017, carotid_endarterectomy_demographics_2018, carotid_endarterectomy_demographics_2019, carotid_endarterectomy_demographics_2020, carotid_endarterectomy_demographics_2021, carotid_endarterectomy_demographics_2022) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  arrange(ENROLID, DTSTART) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  select(ENROLID, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, INDSTRY, MSA) %>% 
  collect()
```




Add demographic data to the database
```{r}
# Add demographic data to the database
carotid_endarterectomy_EEG_SSEP_demographics <- carotid_endarterectomy_EEG_SSEP %>% 
  left_join(carotid_endarterectomy_demographics, by="ENROLID") %>% 
  mutate(any_monitoring = as.factor(case_when(
    (EEG_monitoring == "EEG" | SSEP_monitoring == "SSEP") ~ "monitoring",
    TRUE ~ "no monitoring"))) %>% 
  mutate(male = as.factor(case_when(
  SEX == 1 ~ "yes",
  TRUE ~ "no"))) %>% 
  mutate(year_surgery = case_when(
  (year(SVCDATE) %in% 2006:2011) ~ "2006-2011",
  (year(SVCDATE) %in% 2012:2017) ~ "2012-2017",
  (year(SVCDATE) %in% 2018:2022) ~ "2018-2022")) %>% 
  mutate(rural = as.factor(case_when(
  MSA == 0 ~ "yes",
  TRUE ~ "no"))) %>% 
  mutate(carotid_endarterectomy_type = as.factor(carotid_endarterectomy_type)) %>% 
  mutate(region_category = as.factor(case_when(
  REGION == 1 ~ "Northeast",
  REGION == 2 ~ "North Central",
  REGION == 3 ~ "South",
  REGION == 4 ~ "West",
  TRUE ~ "unknown"))) %>% 
  mutate(employment_status_category = as.factor(case_when(
  EESTATU == 1 ~ "full-time",
  TRUE ~ "other"))) %>% 
  mutate(employment_class_category = as.factor(case_when(
  (EECLASS == 1 | EECLASS == 2 | EECLASS == 3) ~ "salary",
  (EECLASS == 4 | EECLASS == 5 | EECLASS == 6) ~ "hourly",
  TRUE ~ "other"))) %>% 
  mutate(any_monitoring_numeric = case_when(
    any_monitoring == "monitoring" ~ 1,
    TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, any_monitoring, any_monitoring_numeric, AGE, male, year_surgery, rural, region_category, employment_class_category, employment_status_category, carotid_endarterectomy_type, EEG_monitoring, SSEP_monitoring)
```




Demographics carotid endarterectomy
```{r}
# Total surgeries
carotid_endarterectomy_total_surgeries <- carotid_endarterectomy_EEG_SSEP_demographics %>% 
  nrow()
carotid_endarterectomy_total_surgeries


# Total patients
carotid_endarterectomy_total_patients <- carotid_endarterectomy_EEG_SSEP_demographics %>% 
  distinct(ENROLID) %>% 
  nrow()
carotid_endarterectomy_total_patients


# Age
carotid_endarterectomy_age <- carotid_endarterectomy_EEG_SSEP_demographics %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  summarize(
    median_age = median(AGE),
    p25_age = quantile(AGE, 0.25),
    p75_age = quantile(AGE, 0.75),
    mean_age = mean(AGE),
    SD_age = sd(AGE)
  ) %>% 
  collect()
carotid_endarterectomy_age


# Sex
carotid_endarterectomy_sex <- carotid_endarterectomy_EEG_SSEP_demographics %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  reframe(
  sex = CrossTable(male)
)


# Year surgery
carotid_endarterectomy_year_surgery <- carotid_endarterectomy_EEG_SSEP_demographics %>% 
  reframe(
  year_surgery = CrossTable(year_surgery)
)


# Rural
carotid_endarterectomy_rural <- carotid_endarterectomy_EEG_SSEP_demographics %>% 
  reframe(
  rural = CrossTable(rural)
)


# Region
carotid_endarterectomy_region <- carotid_endarterectomy_EEG_SSEP_demographics %>% 
  reframe(
  region = CrossTable(region_category)
)


# Employment status
carotid_endarterectomy_employment_status <- carotid_endarterectomy_EEG_SSEP_demographics %>% 
  reframe(
  employment_status = CrossTable(employment_status_category)
)


# Employment class
carotid_endarterectomy_employment_class <- carotid_endarterectomy_EEG_SSEP_demographics %>% 
  reframe(
  employment_class = CrossTable(employment_class_category)
)
```




Carotid endarterectomy monitoring
```{r}
# Carotid endarterectomy type
carotid_endarterectomy_type <- carotid_endarterectomy_EEG_SSEP_demographics %>% 
  reframe(
  surgery_type = CrossTable(carotid_endarterectomy_type)
)


# Carotid endarterectomy monitoring
carotid_endarterectomy_monitoring_results <- carotid_endarterectomy_EEG_SSEP_demographics %>% 
  reframe(
  EEG_SSEP_monitoring = CrossTable(EEG_monitoring, SSEP_monitoring)
)


# Regression on carotid endarterectomy monitoring 
carotid_endarterectomy_logistic_regression <- glm(any_monitoring_numeric ~ AGE + male + year_surgery + relevel(carotid_endarterectomy_type, ref="no reoperation") + rural + relevel(region_category, ref="West") + relevel(employment_status_category, ref="other") + relevel(employment_class_category, ref="hourly"), data = carotid_endarterectomy_EEG_SSEP_demographics, family = "binomial")

summary(carotid_endarterectomy_logistic_regression)

exp(cbind(OR=coef(carotid_endarterectomy_logistic_regression), confint(carotid_endarterectomy_logistic_regression)))
```




Carotid endarterectomy by year
```{r}
# Carotid endarterectomy monitoring by year
carotid_endarterectomy_monitoring_results_by_year <- carotid_endarterectomy_EEG_SSEP_demographics %>% 
  filter(SVCDATE < as.Date("2023-1-1")) %>% 
  group_by(year(SVCDATE)) %>% 
  reframe(
  EEG_SSEP_monitoring = CrossTable(EEG_monitoring, SSEP_monitoring)
)


carotid_endarterectomy_monitoring_results_by_year_database <- carotid_endarterectomy_EEG_SSEP_demographics %>% 
  filter(SVCDATE < as.Date("2023-1-1")) %>% 
  mutate(
    number_any_monitoring = case_when(
      any_monitoring == "monitoring" ~ 1,
      TRUE ~ 0),
    number_EEG = case_when(
      EEG_monitoring == "EEG" ~ 1,
      TRUE ~ 0),
    number_SSEP = case_when(
      SSEP_monitoring == "SSEP" ~ 1,
      TRUE ~ 0)      
  ) %>% 
  group_by(year(SVCDATE)) %>% 
  summarize(
    count_any_monitoring = sum(number_any_monitoring),
    proportion_any_monitoring = count_any_monitoring / n(),
    count_EEG = sum(number_EEG),
    proportion_EEG = count_EEG / n(),
    count_SSEP = sum(number_SSEP),
    proportion_SSEP = count_SSEP / n()   
  ) %>% 
  collect()
carotid_endarterectomy_monitoring_results_by_year_database


# Proportion of patients with monitoring per year figure
carotid_endarterectomy_monitoring_results_by_year_plot <- ggplot(data=carotid_endarterectomy_monitoring_results_by_year_database) +
  geom_line(aes(x=`year(SVCDATE)`, y=proportion_any_monitoring), lwd=1.5, color="darkgreen") +   
  geom_line(aes(x=`year(SVCDATE)`, y=proportion_EEG), lwd=1.5, color="red") + 
  geom_line(aes(x=`year(SVCDATE)`, y=proportion_SSEP), lwd=1.5, color="blue") + 
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2022) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 1, 0.1), limits = c(0, 1))
carotid_endarterectomy_monitoring_results_by_year_plot
```








## 5. Spinal fusion




Identify patients with spinal fusion
```{r}
# Codes for patients with spinal fusion
CPT_code_spinal_fusion <- c("22800", "22802", "22804", "22808", "22810", "22812")




# Patients with spinal fusion

#################################2006#################################
spinal_fusion_2006_s <- ms_s_2006 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_spinal_fusion) & (PROCTYP=="1")) %>% 
  mutate(spinal_fusion_type = case_when(
    (PROC1 == "22800" | PROC1 == "22802" | PROC1 == "22804") ~ "posterior",
    TRUE ~ "anterior")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, spinal_fusion_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2007#################################
spinal_fusion_2007_s <- ms_s_2007 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_spinal_fusion) & (PROCTYP=="1")) %>% 
  mutate(spinal_fusion_type = case_when(
    (PROC1 == "22800" | PROC1 == "22802" | PROC1 == "22804") ~ "posterior",
    TRUE ~ "anterior")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, spinal_fusion_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2008#################################
spinal_fusion_2008_s <- ms_s_2008 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_spinal_fusion) & (PROCTYP=="1")) %>% 
  mutate(spinal_fusion_type = case_when(
    (PROC1 == "22800" | PROC1 == "22802" | PROC1 == "22804") ~ "posterior",
    TRUE ~ "anterior")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, spinal_fusion_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2009#################################
spinal_fusion_2009_s <- ms_s_2009 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_spinal_fusion) & (PROCTYP=="1")) %>% 
  mutate(spinal_fusion_type = case_when(
    (PROC1 == "22800" | PROC1 == "22802" | PROC1 == "22804") ~ "posterior",
    TRUE ~ "anterior")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, spinal_fusion_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2010#################################
spinal_fusion_2010_s <- ms_s_2010 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_spinal_fusion) & (PROCTYP=="1")) %>% 
  mutate(spinal_fusion_type = case_when(
    (PROC1 == "22800" | PROC1 == "22802" | PROC1 == "22804") ~ "posterior",
    TRUE ~ "anterior")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, spinal_fusion_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2011#################################
spinal_fusion_2011_s <- ms_s_2011 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_spinal_fusion) & (PROCTYP=="1")) %>% 
  mutate(spinal_fusion_type = case_when(
    (PROC1 == "22800" | PROC1 == "22802" | PROC1 == "22804") ~ "posterior",
    TRUE ~ "anterior")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, spinal_fusion_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2012#################################
spinal_fusion_2012_s <- ms_s_2012 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_spinal_fusion) & (PROCTYP=="1")) %>% 
  mutate(spinal_fusion_type = case_when(
    (PROC1 == "22800" | PROC1 == "22802" | PROC1 == "22804") ~ "posterior",
    TRUE ~ "anterior")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, spinal_fusion_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2013#################################
spinal_fusion_2013_s <- ms_s_2013 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_spinal_fusion) & (PROCTYP=="1")) %>% 
  mutate(spinal_fusion_type = case_when(
    (PROC1 == "22800" | PROC1 == "22802" | PROC1 == "22804") ~ "posterior",
    TRUE ~ "anterior")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, spinal_fusion_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2014#################################
spinal_fusion_2014_s <- ms_s_2014 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_spinal_fusion) & (PROCTYP=="1")) %>% 
  mutate(spinal_fusion_type = case_when(
    (PROC1 == "22800" | PROC1 == "22802" | PROC1 == "22804") ~ "posterior",
    TRUE ~ "anterior")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, spinal_fusion_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2015#################################
spinal_fusion_2015_s <- ms_s_2015 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_spinal_fusion) & (PROCTYP=="1")) %>% 
  mutate(spinal_fusion_type = case_when(
    (PROC1 == "22800" | PROC1 == "22802" | PROC1 == "22804") ~ "posterior",
    TRUE ~ "anterior")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, spinal_fusion_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2016#################################
spinal_fusion_2016_s <- ms_s_2016 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_spinal_fusion) & (PROCTYP=="1")) %>% 
  mutate(spinal_fusion_type = case_when(
    (PROC1 == "22800" | PROC1 == "22802" | PROC1 == "22804") ~ "posterior",
    TRUE ~ "anterior")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, spinal_fusion_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2017#################################
spinal_fusion_2017_s <- ms_s_2017 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_spinal_fusion) & (PROCTYP=="1")) %>% 
  mutate(spinal_fusion_type = case_when(
    (PROC1 == "22800" | PROC1 == "22802" | PROC1 == "22804") ~ "posterior",
    TRUE ~ "anterior")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, spinal_fusion_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2018#################################
spinal_fusion_2018_s <- ms_s_2018 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_spinal_fusion) & (PROCTYP=="1")) %>% 
  mutate(spinal_fusion_type = case_when(
    (PROC1 == "22800" | PROC1 == "22802" | PROC1 == "22804") ~ "posterior",
    TRUE ~ "anterior")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, spinal_fusion_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2019#################################
spinal_fusion_2019_s <- ms_s_2019 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_spinal_fusion) & (PROCTYP=="1")) %>% 
  mutate(spinal_fusion_type = case_when(
    (PROC1 == "22800" | PROC1 == "22802" | PROC1 == "22804") ~ "posterior",
    TRUE ~ "anterior")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, spinal_fusion_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2020#################################
spinal_fusion_2020_s <- ms_s_2020 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_spinal_fusion) & (PROCTYP=="1")) %>% 
  mutate(spinal_fusion_type = case_when(
    (PROC1 == "22800" | PROC1 == "22802" | PROC1 == "22804") ~ "posterior",
    TRUE ~ "anterior")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, spinal_fusion_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2021#################################
spinal_fusion_2021_s <- ms_s_2021 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_spinal_fusion) & (PROCTYP=="1")) %>% 
  mutate(spinal_fusion_type = case_when(
    (PROC1 == "22800" | PROC1 == "22802" | PROC1 == "22804") ~ "posterior",
    TRUE ~ "anterior")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, spinal_fusion_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2022#################################
spinal_fusion_2022_s <- ms_s_2022 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_spinal_fusion) & (PROCTYP=="1")) %>% 
  mutate(spinal_fusion_type = case_when(
    (PROC1 == "22800" | PROC1 == "22802" | PROC1 == "22804") ~ "posterior",
    TRUE ~ "anterior")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, spinal_fusion_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))






# Patients with spinal fusion
spinal_fusion <- bind_rows(spinal_fusion_2006_s, spinal_fusion_2007_s, spinal_fusion_2008_s, spinal_fusion_2009_s, spinal_fusion_2010_s, spinal_fusion_2011_s, spinal_fusion_2012_s, spinal_fusion_2013_s, spinal_fusion_2014_s, spinal_fusion_2015_s, spinal_fusion_2016_s, spinal_fusion_2017_s, spinal_fusion_2018_s, spinal_fusion_2019_s, spinal_fusion_2020_s, spinal_fusion_2021_s, spinal_fusion_2022_s) %>% 
  arrange(ENROLID, SVCDATE) %>% 
  collect()
```




Identify the monitoring of patients with spinal fusion
```{r}
# Codes for somatosensory evoked potentials
CPT_code_SSEP <- c("95925", "95926", "95927", "95938")

CPT_code_MEP <- c("95928", "95929", "95939")

CPT_code_EMG <- c("95860", "95861", "95863", "95864", "95870")




# Patients with SSEP, MEP, or EMG

#################################2006#################################
spinal_fusion_SSEP_MEP_EMG_2006 <- ms_s_2006 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!spinal_fusion_2006_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_EMG) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(spinal_fusion_2006_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  mutate(EMG = case_when(
    any((PROC1 %in% CPT_code_EMG)) ~ "EMG", 
    TRUE ~ "No EMG")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, spinal_fusion_type, SSEP, MEP, EMG)
  

#################################2007#################################
spinal_fusion_SSEP_MEP_EMG_2007 <- ms_s_2007 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!spinal_fusion_2007_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_EMG) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(spinal_fusion_2007_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  mutate(EMG = case_when(
    any((PROC1 %in% CPT_code_EMG)) ~ "EMG", 
    TRUE ~ "No EMG")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, spinal_fusion_type, SSEP, MEP, EMG)


#################################2008#################################
spinal_fusion_SSEP_MEP_EMG_2008 <- ms_s_2008 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!spinal_fusion_2008_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_EMG) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(spinal_fusion_2008_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  mutate(EMG = case_when(
    any((PROC1 %in% CPT_code_EMG)) ~ "EMG", 
    TRUE ~ "No EMG")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, spinal_fusion_type, SSEP, MEP, EMG)


#################################2009#################################
spinal_fusion_SSEP_MEP_EMG_2009 <- ms_s_2009 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!spinal_fusion_2009_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_EMG) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(spinal_fusion_2009_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  mutate(EMG = case_when(
    any((PROC1 %in% CPT_code_EMG)) ~ "EMG", 
    TRUE ~ "No EMG")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, spinal_fusion_type, SSEP, MEP, EMG)


#################################2010#################################
spinal_fusion_SSEP_MEP_EMG_2010 <- ms_s_2010 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!spinal_fusion_2010_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_EMG) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(spinal_fusion_2010_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  mutate(EMG = case_when(
    any((PROC1 %in% CPT_code_EMG)) ~ "EMG", 
    TRUE ~ "No EMG")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, spinal_fusion_type, SSEP, MEP, EMG)


#################################2011#################################
spinal_fusion_SSEP_MEP_EMG_2011 <- ms_s_2011 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!spinal_fusion_2011_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_EMG) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(spinal_fusion_2011_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  mutate(EMG = case_when(
    any((PROC1 %in% CPT_code_EMG)) ~ "EMG", 
    TRUE ~ "No EMG")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, spinal_fusion_type, SSEP, MEP, EMG)


#################################2012#################################
spinal_fusion_SSEP_MEP_EMG_2012 <- ms_s_2012 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!spinal_fusion_2012_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_EMG) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(spinal_fusion_2012_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  mutate(EMG = case_when(
    any((PROC1 %in% CPT_code_EMG)) ~ "EMG", 
    TRUE ~ "No EMG")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, spinal_fusion_type, SSEP, MEP, EMG)


#################################2013#################################
spinal_fusion_SSEP_MEP_EMG_2013 <- ms_s_2013 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!spinal_fusion_2013_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_EMG) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(spinal_fusion_2013_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  mutate(EMG = case_when(
    any((PROC1 %in% CPT_code_EMG)) ~ "EMG", 
    TRUE ~ "No EMG")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, spinal_fusion_type, SSEP, MEP, EMG)


#################################2014#################################
spinal_fusion_SSEP_MEP_EMG_2014 <- ms_s_2014 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!spinal_fusion_2014_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_EMG) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(spinal_fusion_2014_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  mutate(EMG = case_when(
    any((PROC1 %in% CPT_code_EMG)) ~ "EMG", 
    TRUE ~ "No EMG")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, spinal_fusion_type, SSEP, MEP, EMG)


#################################2015#################################
spinal_fusion_SSEP_MEP_EMG_2015 <- ms_s_2015 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!spinal_fusion_2015_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_EMG) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(spinal_fusion_2015_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  mutate(EMG = case_when(
    any((PROC1 %in% CPT_code_EMG)) ~ "EMG", 
    TRUE ~ "No EMG")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, spinal_fusion_type, SSEP, MEP, EMG)


#################################2016#################################
spinal_fusion_SSEP_MEP_EMG_2016 <- ms_s_2016 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!spinal_fusion_2016_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_EMG) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(spinal_fusion_2016_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  mutate(EMG = case_when(
    any((PROC1 %in% CPT_code_EMG)) ~ "EMG", 
    TRUE ~ "No EMG")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, spinal_fusion_type, SSEP, MEP, EMG)


#################################2017#################################
spinal_fusion_SSEP_MEP_EMG_2017 <- ms_s_2017 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!spinal_fusion_2017_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_EMG) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(spinal_fusion_2017_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  mutate(EMG = case_when(
    any((PROC1 %in% CPT_code_EMG)) ~ "EMG", 
    TRUE ~ "No EMG")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, spinal_fusion_type, SSEP, MEP, EMG)


#################################2018#################################
spinal_fusion_SSEP_MEP_EMG_2018 <- ms_s_2018 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!spinal_fusion_2018_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_EMG) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(spinal_fusion_2018_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  mutate(EMG = case_when(
    any((PROC1 %in% CPT_code_EMG)) ~ "EMG", 
    TRUE ~ "No EMG")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, spinal_fusion_type, SSEP, MEP, EMG)


#################################2019#################################
spinal_fusion_SSEP_MEP_EMG_2019 <- ms_s_2019 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!spinal_fusion_2019_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_EMG) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(spinal_fusion_2019_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  mutate(EMG = case_when(
    any((PROC1 %in% CPT_code_EMG)) ~ "EMG", 
    TRUE ~ "No EMG")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, spinal_fusion_type, SSEP, MEP, EMG)


#################################2020#################################
spinal_fusion_SSEP_MEP_EMG_2020 <- ms_s_2020 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!spinal_fusion_2020_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_EMG) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(spinal_fusion_2020_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  mutate(EMG = case_when(
    any((PROC1 %in% CPT_code_EMG)) ~ "EMG", 
    TRUE ~ "No EMG")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, spinal_fusion_type, SSEP, MEP, EMG)


#################################2021#################################
spinal_fusion_SSEP_MEP_EMG_2021 <- ms_s_2021 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!spinal_fusion_2021_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_EMG) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(spinal_fusion_2021_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  mutate(EMG = case_when(
    any((PROC1 %in% CPT_code_EMG)) ~ "EMG", 
    TRUE ~ "No EMG")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, spinal_fusion_type, SSEP, MEP, EMG)


#################################2022#################################
spinal_fusion_SSEP_MEP_EMG_2022 <- ms_s_2022 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!spinal_fusion_2022_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_EMG) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(spinal_fusion_2022_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  mutate(EMG = case_when(
    any((PROC1 %in% CPT_code_EMG)) ~ "EMG", 
    TRUE ~ "No EMG")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, spinal_fusion_type, SSEP, MEP, EMG)




# Patients with spinal fusion with or without SSEP, MEP, EMG
spinal_fusion_SSEP_MEP_EMG <- bind_rows(spinal_fusion_SSEP_MEP_EMG_2006, spinal_fusion_SSEP_MEP_EMG_2007, spinal_fusion_SSEP_MEP_EMG_2008, spinal_fusion_SSEP_MEP_EMG_2009, spinal_fusion_SSEP_MEP_EMG_2010, spinal_fusion_SSEP_MEP_EMG_2011, spinal_fusion_SSEP_MEP_EMG_2012, spinal_fusion_SSEP_MEP_EMG_2013, spinal_fusion_SSEP_MEP_EMG_2014, spinal_fusion_SSEP_MEP_EMG_2015, spinal_fusion_SSEP_MEP_EMG_2016, spinal_fusion_SSEP_MEP_EMG_2017, spinal_fusion_SSEP_MEP_EMG_2018, spinal_fusion_SSEP_MEP_EMG_2019, spinal_fusion_SSEP_MEP_EMG_2020, spinal_fusion_SSEP_MEP_EMG_2021, spinal_fusion_SSEP_MEP_EMG_2022) %>% 
  arrange(ENROLID, SVCDATE) %>% 
  collect()
```




Spinal fusion demographics
```{r}
#################################2006#################################
spinal_fusion_demographics_2006 <- ms_t_2006 %>% 
  filter(ENROLID %in% !!spinal_fusion_SSEP_MEP_EMG$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2007#################################
spinal_fusion_demographics_2007 <- ms_t_2007 %>% 
  filter(ENROLID %in% !!spinal_fusion_SSEP_MEP_EMG$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2008#################################
spinal_fusion_demographics_2008 <- ms_t_2008 %>% 
  filter(ENROLID %in% !!spinal_fusion_SSEP_MEP_EMG$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2009#################################
spinal_fusion_demographics_2009 <- ms_t_2009 %>% 
  filter(ENROLID %in% !!spinal_fusion_SSEP_MEP_EMG$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2010#################################
spinal_fusion_demographics_2010 <- ms_t_2010 %>% 
  filter(ENROLID %in% !!spinal_fusion_SSEP_MEP_EMG$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2011#################################
spinal_fusion_demographics_2011 <- ms_t_2011 %>% 
  filter(ENROLID %in% !!spinal_fusion_SSEP_MEP_EMG$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2012#################################
spinal_fusion_demographics_2012 <- ms_t_2012 %>% 
  filter(ENROLID %in% !!spinal_fusion_SSEP_MEP_EMG$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2013#################################
spinal_fusion_demographics_2013 <- ms_t_2013 %>% 
  filter(ENROLID %in% !!spinal_fusion_SSEP_MEP_EMG$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2014#################################
spinal_fusion_demographics_2014 <- ms_t_2014 %>% 
  filter(ENROLID %in% !!spinal_fusion_SSEP_MEP_EMG$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2015#################################
spinal_fusion_demographics_2015 <- ms_t_2015 %>% 
  filter(ENROLID %in% !!spinal_fusion_SSEP_MEP_EMG$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2016#################################
spinal_fusion_demographics_2016 <- ms_t_2016 %>% 
  filter(ENROLID %in% !!spinal_fusion_SSEP_MEP_EMG$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2017#################################
spinal_fusion_demographics_2017 <- ms_t_2017 %>% 
  filter(ENROLID %in% !!spinal_fusion_SSEP_MEP_EMG$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2018#################################
spinal_fusion_demographics_2018 <- ms_t_2018 %>% 
  filter(ENROLID %in% !!spinal_fusion_SSEP_MEP_EMG$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2019#################################
spinal_fusion_demographics_2019 <- ms_t_2019 %>% 
  filter(ENROLID %in% !!spinal_fusion_SSEP_MEP_EMG$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2020#################################
spinal_fusion_demographics_2020 <- ms_t_2020 %>% 
  filter(ENROLID %in% !!spinal_fusion_SSEP_MEP_EMG$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2021#################################
spinal_fusion_demographics_2021 <- ms_t_2021 %>% 
  filter(ENROLID %in% !!spinal_fusion_SSEP_MEP_EMG$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2022#################################
spinal_fusion_demographics_2022 <- ms_t_2022 %>% 
  filter(ENROLID %in% !!spinal_fusion_SSEP_MEP_EMG$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()




# Demographics
spinal_fusion_demographics <- bind_rows(spinal_fusion_demographics_2006, spinal_fusion_demographics_2007, spinal_fusion_demographics_2008, spinal_fusion_demographics_2009, spinal_fusion_demographics_2010, spinal_fusion_demographics_2011, spinal_fusion_demographics_2012, spinal_fusion_demographics_2013, spinal_fusion_demographics_2014, spinal_fusion_demographics_2015, spinal_fusion_demographics_2016, spinal_fusion_demographics_2017, spinal_fusion_demographics_2018, spinal_fusion_demographics_2019, spinal_fusion_demographics_2020, spinal_fusion_demographics_2021, spinal_fusion_demographics_2022) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  arrange(ENROLID, DTSTART) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  select(ENROLID, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, INDSTRY, MSA) %>% 
  collect()
```




Add demographic data to the database
```{r}
# Add demographic data to the database
spinal_fusion_SSEP_MEP_EMG_demographics <- spinal_fusion_SSEP_MEP_EMG %>% 
  left_join(spinal_fusion_demographics, by="ENROLID") %>% 
  mutate(SSEP = as.factor(SSEP),
         MEP = as.factor(MEP),
         EMG = as.factor(EMG)) %>% 
  mutate(any_monitoring = as.factor(case_when(
    (SSEP == "SSEP" | MEP == "MEP" | EMG == "EMG") ~ "monitoring",
    TRUE ~ "no monitoring"))) %>% 
  mutate(male = as.factor(case_when(
  SEX == 1 ~ "yes",
  TRUE ~ "no"))) %>% 
  mutate(year_surgery = case_when(
  (year(SVCDATE) %in% 2006:2011) ~ "2006-2011",
  (year(SVCDATE) %in% 2012:2017) ~ "2012-2017",
  (year(SVCDATE) %in% 2018:2022) ~ "2018-2022")) %>% 
  mutate(rural = as.factor(case_when(
  MSA == 0 ~ "yes",
  TRUE ~ "no"))) %>% 
  mutate(region_category = as.factor(case_when(
  REGION == 1 ~ "Northeast",
  REGION == 2 ~ "North Central",
  REGION == 3 ~ "South",
  REGION == 4 ~ "West",
  TRUE ~ "unknown"))) %>% 
  mutate(employment_status_category = as.factor(case_when(
  EESTATU == 1 ~ "full-time",
  TRUE ~ "other"))) %>% 
  mutate(employment_class_category = as.factor(case_when(
  (EECLASS == 1 | EECLASS == 2 | EECLASS == 3) ~ "salary",
  (EECLASS == 4 | EECLASS == 5 | EECLASS == 6) ~ "hourly",
  TRUE ~ "other"))) %>% 
  mutate(any_monitoring_numeric = case_when(
    any_monitoring == "monitoring" ~ 1,
    TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, any_monitoring, any_monitoring_numeric, AGE, male, year_surgery, rural, region_category, employment_class_category, employment_status_category, spinal_fusion_type, SSEP, MEP, EMG)
```




Demographics spinal fusion
```{r}
# Total surgeries
spinal_fusion_total_surgeries <- spinal_fusion_SSEP_MEP_EMG_demographics %>% 
  nrow()
spinal_fusion_total_surgeries


# Total patients
spinal_fusion_total_patients <- spinal_fusion_SSEP_MEP_EMG_demographics %>% 
  distinct(ENROLID) %>% 
  nrow()
spinal_fusion_total_patients


# Age
spinal_fusion_age <- spinal_fusion_SSEP_MEP_EMG_demographics %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  summarize(
    median_age = median(AGE),
    p25_age = quantile(AGE, 0.25),
    p75_age = quantile(AGE, 0.75),
    mean_age = mean(AGE),
    SD_age = sd(AGE)
  ) %>% 
  collect()
spinal_fusion_age


# Sex
spinal_fusion_sex <- spinal_fusion_SSEP_MEP_EMG_demographics %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  reframe(
  sex = CrossTable(male)
)


# Year surgery
spinal_fusion_year_surgery <- spinal_fusion_SSEP_MEP_EMG_demographics %>% 
  reframe(
  year_surgery = CrossTable(year_surgery)
)


# Rural
spinal_fusion_rural <- spinal_fusion_SSEP_MEP_EMG_demographics %>% 
  reframe(
  rural = CrossTable(rural)
)


# Region
spinal_fusion_region <- spinal_fusion_SSEP_MEP_EMG_demographics %>% 
  reframe(
  region = CrossTable(region_category)
)


# Employment status
spinal_fusion_employment_status <- spinal_fusion_SSEP_MEP_EMG_demographics %>% 
  reframe(
  employment_status = CrossTable(employment_status_category)
)


# Employment class
spinal_fusion_employment_class <- spinal_fusion_SSEP_MEP_EMG_demographics %>% 
  reframe(
  employment_class = CrossTable(employment_class_category)
)
```




Spinal fusion monitoring
```{r}
# Spinal fusion type
spinal_fusion_surgery_type <- spinal_fusion_SSEP_MEP_EMG_demographics %>% 
  reframe(
  surgery_type = CrossTable(spinal_fusion_type)
)


# Spinal fusion monitoring
spinal_fusion_monitoring_results <- spinal_fusion_SSEP_MEP_EMG_demographics %>% 
  select(SSEP, MEP, EMG) %>% 
  ftable()
spinal_fusion_monitoring_results


# Regression on spinal fusion monitoring 
spinal_fusion_logistic_regression <- glm(any_monitoring_numeric ~ AGE + male +  year_surgery + spinal_fusion_type + rural + relevel(region_category, ref="West") + relevel(employment_status_category, ref="other") + relevel(employment_class_category, ref="hourly"), data = spinal_fusion_SSEP_MEP_EMG_demographics, family = "binomial")

summary(spinal_fusion_logistic_regression)

exp(cbind(OR=coef(spinal_fusion_logistic_regression), confint(spinal_fusion_logistic_regression)))
```




Spinal fusion by year
```{r}
# Spinal fusion monitoring by year
spinal_fusion_monitoring_results_by_year <- spinal_fusion_SSEP_MEP_EMG_demographics %>% 
  group_by(year(SVCDATE)) %>% 
  select(SSEP, MEP, EMG) %>% 
  ftable()
spinal_fusion_monitoring_results_by_year


spinal_fusion_monitoring_results_by_year_database <- spinal_fusion_SSEP_MEP_EMG_demographics %>% 
  filter(SVCDATE < as.Date("2023-1-1")) %>% 
  mutate(
    number_any_monitoring = case_when(
      any_monitoring == "monitoring" ~ 1,
      TRUE ~ 0),
    number_SSEP = case_when(
      SSEP == "SSEP" ~ 1,
      TRUE ~ 0),
    number_MEP = case_when(
      MEP == "MEP" ~ 1,
      TRUE ~ 0),
    number_EMG = case_when(
      EMG == "EMG" ~ 1,
      TRUE ~ 0)    
  ) %>% 
  group_by(year(SVCDATE)) %>% 
  summarize(
    count_any_monitoring = sum(number_any_monitoring),
    proportion_any_monitoring = count_any_monitoring / n(),
    count_SSEP = sum(number_SSEP),
    proportion_SSEP = count_SSEP / n(),
    count_MEP = sum(number_MEP),
    proportion_MEP = count_MEP / n(),
    count_EMG = sum(number_EMG),
    proportion_EMG = count_EMG / n(),
    total_patients = n()
  ) %>% 
  collect()
spinal_fusion_monitoring_results_by_year_database


# Proportion of patients with monitoring per year figure
spinal_fusion_monitoring_results_by_year_plot <- ggplot(data=spinal_fusion_monitoring_results_by_year_database) +
  geom_line(aes(x=`year(SVCDATE)`, y=proportion_any_monitoring), lwd=1.5, color="darkgreen") +   
  geom_line(aes(x=`year(SVCDATE)`, y=proportion_SSEP), lwd=1.5, color="red") + 
  geom_line(aes(x=`year(SVCDATE)`, y=proportion_MEP), lwd=1.5, color="blue") + 
  geom_line(aes(x=`year(SVCDATE)`, y=proportion_EMG), lwd=1.5, color="darkorange") + 
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2022) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 1, 0.1), limits = c(0, 1))
spinal_fusion_monitoring_results_by_year_plot
```








## 6. Release of tethered spinal cord




Identify patients with release of tethered spinal cord
```{r}
# Codes for patients with release of tethered spinal cord
CPT_code_tethered_cord <- c("63200")




# Patients with release of tethered spinal cord

#################################2006#################################
tethered_cord_2006_s <- ms_s_2006 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_tethered_cord) & (PROCTYP=="1")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2007#################################
tethered_cord_2007_s <- ms_s_2007 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_tethered_cord) & (PROCTYP=="1")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2008#################################
tethered_cord_2008_s <- ms_s_2008 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_tethered_cord) & (PROCTYP=="1")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2009#################################
tethered_cord_2009_s <- ms_s_2009 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_tethered_cord) & (PROCTYP=="1")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2010#################################
tethered_cord_2010_s <- ms_s_2010 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_tethered_cord) & (PROCTYP=="1")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2011#################################
tethered_cord_2011_s <- ms_s_2011 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_tethered_cord) & (PROCTYP=="1")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2012#################################
tethered_cord_2012_s <- ms_s_2012 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_tethered_cord) & (PROCTYP=="1")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2013#################################
tethered_cord_2013_s <- ms_s_2013 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_tethered_cord) & (PROCTYP=="1")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2014#################################
tethered_cord_2014_s <- ms_s_2014 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_tethered_cord) & (PROCTYP=="1")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2015#################################
tethered_cord_2015_s <- ms_s_2015 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_tethered_cord) & (PROCTYP=="1")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2016#################################
tethered_cord_2016_s <- ms_s_2016 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_tethered_cord) & (PROCTYP=="1")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2017#################################
tethered_cord_2017_s <- ms_s_2017 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_tethered_cord) & (PROCTYP=="1")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2018#################################
tethered_cord_2018_s <- ms_s_2018 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_tethered_cord) & (PROCTYP=="1")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2019#################################
tethered_cord_2019_s <- ms_s_2019 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_tethered_cord) & (PROCTYP=="1")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2020#################################
tethered_cord_2020_s <- ms_s_2020 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_tethered_cord) & (PROCTYP=="1")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2021#################################
tethered_cord_2021_s <- ms_s_2021 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_tethered_cord) & (PROCTYP=="1")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2022#################################
tethered_cord_2022_s <- ms_s_2022 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_tethered_cord) & (PROCTYP=="1")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))




# Patients with release of tethered cord
tethered_cord <- bind_rows(tethered_cord_2006_s, tethered_cord_2007_s, tethered_cord_2008_s, tethered_cord_2009_s, tethered_cord_2010_s, tethered_cord_2011_s, tethered_cord_2012_s, tethered_cord_2013_s, tethered_cord_2014_s, tethered_cord_2015_s, tethered_cord_2016_s, tethered_cord_2017_s, tethered_cord_2018_s, tethered_cord_2019_s, tethered_cord_2020_s, tethered_cord_2021_s, tethered_cord_2022_s) %>% 
  arrange(ENROLID, SVCDATE) %>% 
  collect()
```




Identify the monitoring of patients with release of tethered cord
```{r}
# Codes for monitoring
CPT_code_SSEP <- c("95925", "95926", "95927", "95938")

CPT_code_MEP <- c("95928", "95929", "95939")

CPT_code_EMG <- c("95860", "95861", "95863", "95864", "95870")

CPT_code_sphincter_EMG <- c("51784", "51785")




# Patients with SSEP, MEP, EMG, or sphincter EMG

#################################2006#################################
tethered_cord_SSEP_MEP_EMG_2006 <- ms_s_2006 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!tethered_cord_2006_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_EMG) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_sphincter_EMG) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(tethered_cord_2006_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  mutate(EMG = case_when(
    any((PROC1 %in% CPT_code_EMG)) ~ "EMG", 
    TRUE ~ "No EMG")) %>% 
  mutate(sphincter_EMG = case_when(
    any((PROC1 %in% CPT_code_sphincter_EMG)) ~ "sphincter EMG", 
    TRUE ~ "no sphincter EMG")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, SSEP, MEP, EMG, sphincter_EMG)
  

#################################2007#################################
tethered_cord_SSEP_MEP_EMG_2007 <- ms_s_2007 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!tethered_cord_2007_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_EMG) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_sphincter_EMG) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(tethered_cord_2007_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  mutate(EMG = case_when(
    any((PROC1 %in% CPT_code_EMG)) ~ "EMG", 
    TRUE ~ "No EMG")) %>% 
  mutate(sphincter_EMG = case_when(
    any((PROC1 %in% CPT_code_sphincter_EMG)) ~ "sphincter EMG", 
    TRUE ~ "no sphincter EMG")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, SSEP, MEP, EMG, sphincter_EMG)


#################################2008#################################
tethered_cord_SSEP_MEP_EMG_2008 <- ms_s_2008 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!tethered_cord_2008_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_EMG) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_sphincter_EMG) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(tethered_cord_2008_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  mutate(EMG = case_when(
    any((PROC1 %in% CPT_code_EMG)) ~ "EMG", 
    TRUE ~ "No EMG")) %>% 
  mutate(sphincter_EMG = case_when(
    any((PROC1 %in% CPT_code_sphincter_EMG)) ~ "sphincter EMG", 
    TRUE ~ "no sphincter EMG")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, SSEP, MEP, EMG, sphincter_EMG)


#################################2009#################################
tethered_cord_SSEP_MEP_EMG_2009 <- ms_s_2009 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!tethered_cord_2009_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_EMG) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_sphincter_EMG) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(tethered_cord_2009_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  mutate(EMG = case_when(
    any((PROC1 %in% CPT_code_EMG)) ~ "EMG", 
    TRUE ~ "No EMG")) %>% 
  mutate(sphincter_EMG = case_when(
    any((PROC1 %in% CPT_code_sphincter_EMG)) ~ "sphincter EMG", 
    TRUE ~ "no sphincter EMG")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, SSEP, MEP, EMG, sphincter_EMG)


#################################2010#################################
tethered_cord_SSEP_MEP_EMG_2010 <- ms_s_2010 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!tethered_cord_2010_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_EMG) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_sphincter_EMG) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(tethered_cord_2010_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  mutate(EMG = case_when(
    any((PROC1 %in% CPT_code_EMG)) ~ "EMG", 
    TRUE ~ "No EMG")) %>% 
  mutate(sphincter_EMG = case_when(
    any((PROC1 %in% CPT_code_sphincter_EMG)) ~ "sphincter EMG", 
    TRUE ~ "no sphincter EMG")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, SSEP, MEP, EMG, sphincter_EMG)


#################################2011#################################
tethered_cord_SSEP_MEP_EMG_2011 <- ms_s_2011 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!tethered_cord_2011_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_EMG) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_sphincter_EMG) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(tethered_cord_2011_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  mutate(EMG = case_when(
    any((PROC1 %in% CPT_code_EMG)) ~ "EMG", 
    TRUE ~ "No EMG")) %>% 
  mutate(sphincter_EMG = case_when(
    any((PROC1 %in% CPT_code_sphincter_EMG)) ~ "sphincter EMG", 
    TRUE ~ "no sphincter EMG")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, SSEP, MEP, EMG, sphincter_EMG)


#################################2012#################################
tethered_cord_SSEP_MEP_EMG_2012 <- ms_s_2012 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!tethered_cord_2012_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_EMG) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_sphincter_EMG) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(tethered_cord_2012_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  mutate(EMG = case_when(
    any((PROC1 %in% CPT_code_EMG)) ~ "EMG", 
    TRUE ~ "No EMG")) %>% 
  mutate(sphincter_EMG = case_when(
    any((PROC1 %in% CPT_code_sphincter_EMG)) ~ "sphincter EMG", 
    TRUE ~ "no sphincter EMG")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, SSEP, MEP, EMG, sphincter_EMG)


#################################2013#################################
tethered_cord_SSEP_MEP_EMG_2013 <- ms_s_2013 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!tethered_cord_2013_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_EMG) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_sphincter_EMG) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(tethered_cord_2013_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  mutate(EMG = case_when(
    any((PROC1 %in% CPT_code_EMG)) ~ "EMG", 
    TRUE ~ "No EMG")) %>% 
  mutate(sphincter_EMG = case_when(
    any((PROC1 %in% CPT_code_sphincter_EMG)) ~ "sphincter EMG", 
    TRUE ~ "no sphincter EMG")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, SSEP, MEP, EMG, sphincter_EMG)


#################################2014#################################
tethered_cord_SSEP_MEP_EMG_2014 <- ms_s_2014 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!tethered_cord_2014_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_EMG) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_sphincter_EMG) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(tethered_cord_2014_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  mutate(EMG = case_when(
    any((PROC1 %in% CPT_code_EMG)) ~ "EMG", 
    TRUE ~ "No EMG")) %>% 
  mutate(sphincter_EMG = case_when(
    any((PROC1 %in% CPT_code_sphincter_EMG)) ~ "sphincter EMG", 
    TRUE ~ "no sphincter EMG")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, SSEP, MEP, EMG, sphincter_EMG)


#################################2015#################################
tethered_cord_SSEP_MEP_EMG_2015 <- ms_s_2015 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!tethered_cord_2015_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_EMG) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_sphincter_EMG) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(tethered_cord_2015_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  mutate(EMG = case_when(
    any((PROC1 %in% CPT_code_EMG)) ~ "EMG", 
    TRUE ~ "No EMG")) %>% 
  mutate(sphincter_EMG = case_when(
    any((PROC1 %in% CPT_code_sphincter_EMG)) ~ "sphincter EMG", 
    TRUE ~ "no sphincter EMG")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, SSEP, MEP, EMG, sphincter_EMG)


#################################2016#################################
tethered_cord_SSEP_MEP_EMG_2016 <- ms_s_2016 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!tethered_cord_2016_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_EMG) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_sphincter_EMG) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(tethered_cord_2016_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  mutate(EMG = case_when(
    any((PROC1 %in% CPT_code_EMG)) ~ "EMG", 
    TRUE ~ "No EMG")) %>% 
  mutate(sphincter_EMG = case_when(
    any((PROC1 %in% CPT_code_sphincter_EMG)) ~ "sphincter EMG", 
    TRUE ~ "no sphincter EMG")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, SSEP, MEP, EMG, sphincter_EMG)


#################################2017#################################
tethered_cord_SSEP_MEP_EMG_2017 <- ms_s_2017 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!tethered_cord_2017_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_EMG) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_sphincter_EMG) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(tethered_cord_2017_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  mutate(EMG = case_when(
    any((PROC1 %in% CPT_code_EMG)) ~ "EMG", 
    TRUE ~ "No EMG")) %>% 
  mutate(sphincter_EMG = case_when(
    any((PROC1 %in% CPT_code_sphincter_EMG)) ~ "sphincter EMG", 
    TRUE ~ "no sphincter EMG")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, SSEP, MEP, EMG, sphincter_EMG)


#################################2018#################################
tethered_cord_SSEP_MEP_EMG_2018 <- ms_s_2018 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!tethered_cord_2018_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_EMG) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_sphincter_EMG) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(tethered_cord_2018_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  mutate(EMG = case_when(
    any((PROC1 %in% CPT_code_EMG)) ~ "EMG", 
    TRUE ~ "No EMG")) %>% 
  mutate(sphincter_EMG = case_when(
    any((PROC1 %in% CPT_code_sphincter_EMG)) ~ "sphincter EMG", 
    TRUE ~ "no sphincter EMG")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, SSEP, MEP, EMG, sphincter_EMG)


#################################2019#################################
tethered_cord_SSEP_MEP_EMG_2019 <- ms_s_2019 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!tethered_cord_2019_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_EMG) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_sphincter_EMG) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(tethered_cord_2019_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  mutate(EMG = case_when(
    any((PROC1 %in% CPT_code_EMG)) ~ "EMG", 
    TRUE ~ "No EMG")) %>% 
  mutate(sphincter_EMG = case_when(
    any((PROC1 %in% CPT_code_sphincter_EMG)) ~ "sphincter EMG", 
    TRUE ~ "no sphincter EMG")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, SSEP, MEP, EMG, sphincter_EMG)


#################################2020#################################
tethered_cord_SSEP_MEP_EMG_2020 <- ms_s_2020 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!tethered_cord_2020_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_EMG) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_sphincter_EMG) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(tethered_cord_2020_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  mutate(EMG = case_when(
    any((PROC1 %in% CPT_code_EMG)) ~ "EMG", 
    TRUE ~ "No EMG")) %>% 
  mutate(sphincter_EMG = case_when(
    any((PROC1 %in% CPT_code_sphincter_EMG)) ~ "sphincter EMG", 
    TRUE ~ "no sphincter EMG")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, SSEP, MEP, EMG, sphincter_EMG)


#################################2021#################################
tethered_cord_SSEP_MEP_EMG_2021 <- ms_s_2021 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!tethered_cord_2021_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_EMG) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_sphincter_EMG) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(tethered_cord_2021_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  mutate(EMG = case_when(
    any((PROC1 %in% CPT_code_EMG)) ~ "EMG", 
    TRUE ~ "No EMG")) %>% 
  mutate(sphincter_EMG = case_when(
    any((PROC1 %in% CPT_code_sphincter_EMG)) ~ "sphincter EMG", 
    TRUE ~ "no sphincter EMG")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, SSEP, MEP, EMG, sphincter_EMG)


#################################2022#################################
tethered_cord_SSEP_MEP_EMG_2022 <- ms_s_2022 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!tethered_cord_2022_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_EMG) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_sphincter_EMG) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(tethered_cord_2022_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  mutate(EMG = case_when(
    any((PROC1 %in% CPT_code_EMG)) ~ "EMG", 
    TRUE ~ "No EMG")) %>% 
  mutate(sphincter_EMG = case_when(
    any((PROC1 %in% CPT_code_sphincter_EMG)) ~ "sphincter EMG", 
    TRUE ~ "no sphincter EMG")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, SSEP, MEP, EMG, sphincter_EMG)




# Patients with release of tethered cord with or without SSEP, MEP, EMG, sphincter EMG
tethered_cord_SSEP_MEP_EMG <- bind_rows(tethered_cord_SSEP_MEP_EMG_2006, tethered_cord_SSEP_MEP_EMG_2007, tethered_cord_SSEP_MEP_EMG_2008, tethered_cord_SSEP_MEP_EMG_2009, tethered_cord_SSEP_MEP_EMG_2010, tethered_cord_SSEP_MEP_EMG_2011, tethered_cord_SSEP_MEP_EMG_2012, tethered_cord_SSEP_MEP_EMG_2013, tethered_cord_SSEP_MEP_EMG_2014, tethered_cord_SSEP_MEP_EMG_2015, tethered_cord_SSEP_MEP_EMG_2016, tethered_cord_SSEP_MEP_EMG_2017, tethered_cord_SSEP_MEP_EMG_2018, tethered_cord_SSEP_MEP_EMG_2019, tethered_cord_SSEP_MEP_EMG_2020, tethered_cord_SSEP_MEP_EMG_2021, tethered_cord_SSEP_MEP_EMG_2022) %>% 
  arrange(ENROLID, SVCDATE) %>% 
  collect()
```




Tethered cord release demographics
```{r}
#################################2006#################################
tethered_cord_demographics_2006 <- ms_t_2006 %>% 
  filter(ENROLID %in% !!tethered_cord_SSEP_MEP_EMG$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2007#################################
tethered_cord_demographics_2007 <- ms_t_2007 %>% 
  filter(ENROLID %in% !!tethered_cord_SSEP_MEP_EMG$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2008#################################
tethered_cord_demographics_2008 <- ms_t_2008 %>% 
  filter(ENROLID %in% !!tethered_cord_SSEP_MEP_EMG$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2009#################################
tethered_cord_demographics_2009 <- ms_t_2009 %>% 
  filter(ENROLID %in% !!tethered_cord_SSEP_MEP_EMG$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2010#################################
tethered_cord_demographics_2010 <- ms_t_2010 %>% 
  filter(ENROLID %in% !!tethered_cord_SSEP_MEP_EMG$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2011#################################
tethered_cord_demographics_2011 <- ms_t_2011 %>% 
  filter(ENROLID %in% !!tethered_cord_SSEP_MEP_EMG$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2012#################################
tethered_cord_demographics_2012 <- ms_t_2012 %>% 
  filter(ENROLID %in% !!tethered_cord_SSEP_MEP_EMG$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2013#################################
tethered_cord_demographics_2013 <- ms_t_2013 %>% 
  filter(ENROLID %in% !!tethered_cord_SSEP_MEP_EMG$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2014#################################
tethered_cord_demographics_2014 <- ms_t_2014 %>% 
  filter(ENROLID %in% !!tethered_cord_SSEP_MEP_EMG$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2015#################################
tethered_cord_demographics_2015 <- ms_t_2015 %>% 
  filter(ENROLID %in% !!tethered_cord_SSEP_MEP_EMG$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2016#################################
tethered_cord_demographics_2016 <- ms_t_2016 %>% 
  filter(ENROLID %in% !!tethered_cord_SSEP_MEP_EMG$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2017#################################
tethered_cord_demographics_2017 <- ms_t_2017 %>% 
  filter(ENROLID %in% !!tethered_cord_SSEP_MEP_EMG$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2018#################################
tethered_cord_demographics_2018 <- ms_t_2018 %>% 
  filter(ENROLID %in% !!tethered_cord_SSEP_MEP_EMG$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2019#################################
tethered_cord_demographics_2019 <- ms_t_2019 %>% 
  filter(ENROLID %in% !!tethered_cord_SSEP_MEP_EMG$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2020#################################
tethered_cord_demographics_2020 <- ms_t_2020 %>% 
  filter(ENROLID %in% !!tethered_cord_SSEP_MEP_EMG$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2021#################################
tethered_cord_demographics_2021 <- ms_t_2021 %>% 
  filter(ENROLID %in% !!tethered_cord_SSEP_MEP_EMG$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2022#################################
tethered_cord_demographics_2022 <- ms_t_2022 %>% 
  filter(ENROLID %in% !!tethered_cord_SSEP_MEP_EMG$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()




# Demographics
tethered_cord_demographics <- bind_rows(tethered_cord_demographics_2006, tethered_cord_demographics_2007, tethered_cord_demographics_2008, tethered_cord_demographics_2009, tethered_cord_demographics_2010, tethered_cord_demographics_2011, tethered_cord_demographics_2012, tethered_cord_demographics_2013, tethered_cord_demographics_2014, tethered_cord_demographics_2015, tethered_cord_demographics_2016, tethered_cord_demographics_2017, tethered_cord_demographics_2018, tethered_cord_demographics_2019, tethered_cord_demographics_2020, tethered_cord_demographics_2021, tethered_cord_demographics_2022) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  arrange(ENROLID, DTSTART) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  select(ENROLID, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, INDSTRY, MSA) %>% 
  collect()
```




Add demographic data to the database
```{r}
# Add demographic data to the database
tethered_cord_SSEP_MEP_EMG_demographics <- tethered_cord_SSEP_MEP_EMG %>% 
  left_join(tethered_cord_demographics, by="ENROLID") %>% 
  mutate(SSEP = as.factor(SSEP),
         MEP = as.factor(MEP),
         EMG = as.factor(EMG),
         sphincter_EMG = as.factor(sphincter_EMG)) %>% 
  mutate(any_monitoring = as.factor(case_when(
    (SSEP == "SSEP" | MEP == "MEP" | EMG == "EMG" | sphincter_EMG == "sphincter EMG") ~ "monitoring",
    TRUE ~ "no monitoring"))) %>% 
  mutate(male = as.factor(case_when(
  SEX == 1 ~ "yes",
  TRUE ~ "no"))) %>% 
  mutate(year_surgery = case_when(
  (year(SVCDATE) %in% 2006:2011) ~ "2006-2011",
  (year(SVCDATE) %in% 2012:2017) ~ "2012-2017",
  (year(SVCDATE) %in% 2018:2022) ~ "2018-2022")) %>% 
  mutate(rural = as.factor(case_when(
  MSA == 0 ~ "yes",
  TRUE ~ "no"))) %>% 
  mutate(region_category = as.factor(case_when(
  REGION == 1 ~ "Northeast",
  REGION == 2 ~ "North Central",
  REGION == 3 ~ "South",
  REGION == 4 ~ "West",
  TRUE ~ "unknown"))) %>% 
  mutate(employment_status_category = as.factor(case_when(
  EESTATU == 1 ~ "full-time",
  TRUE ~ "other"))) %>% 
  mutate(employment_class_category = as.factor(case_when(
  (EECLASS == 1 | EECLASS == 2 | EECLASS == 3) ~ "salary",
  (EECLASS == 4 | EECLASS == 5 | EECLASS == 6) ~ "hourly",
  TRUE ~ "other"))) %>% 
  mutate(any_monitoring_numeric = case_when(
    any_monitoring == "monitoring" ~ 1,
    TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, any_monitoring, any_monitoring_numeric, AGE, male, year_surgery, rural, region_category, employment_class_category, employment_status_category, SSEP, MEP, EMG, sphincter_EMG)
```




Demographics tethered cord
```{r}
# Total surgeries
tethered_cord_total_surgeries <- tethered_cord_SSEP_MEP_EMG_demographics %>% 
  nrow()
tethered_cord_total_surgeries


# Total patients
tethered_cord_total_patients <- tethered_cord_SSEP_MEP_EMG_demographics %>% 
  distinct(ENROLID) %>% 
  nrow()
tethered_cord_total_patients


# Age
tethered_cord_age <- tethered_cord_SSEP_MEP_EMG_demographics %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  summarize(
    median_age = median(AGE),
    p25_age = quantile(AGE, 0.25),
    p75_age = quantile(AGE, 0.75),
    mean_age = mean(AGE),
    SD_age = sd(AGE)
  ) %>% 
  collect()
tethered_cord_age


# Sex
tethered_cord_sex <- tethered_cord_SSEP_MEP_EMG_demographics %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  reframe(
  sex = CrossTable(male)
)


# Year surgery
tethered_cord_year_surgery <- tethered_cord_SSEP_MEP_EMG_demographics %>% 
  reframe(
  year_surgery = CrossTable(year_surgery)
)


# Rural
tethered_cord_rural <- tethered_cord_SSEP_MEP_EMG_demographics %>% 
  reframe(
  rural = CrossTable(rural)
)


# Region
tethered_cord_region <- tethered_cord_SSEP_MEP_EMG_demographics %>% 
  reframe(
  region = CrossTable(region_category)
)


# Employment status
tethered_cord_employment_status <- tethered_cord_SSEP_MEP_EMG_demographics %>% 
  reframe(
  employment_status = CrossTable(employment_status_category)
)


# Employment class
tethered_cord_employment_class <- tethered_cord_SSEP_MEP_EMG_demographics %>% 
  reframe(
  employment_class = CrossTable(employment_class_category)
)
```




Release of tethered cord monitoring
```{r}
# Tethered cord monitoring
tethered_cord_monitoring_results <- tethered_cord_SSEP_MEP_EMG_demographics %>% 
  select(SSEP, MEP, EMG, sphincter_EMG) %>% 
  ftable()
tethered_cord_monitoring_results


# Regression on tethered cord monitoring 
tethered_cord_logistic_regression <- glm(any_monitoring_numeric ~ AGE + male +  year_surgery + rural + relevel(region_category, ref="West") + relevel(employment_status_category, ref="other") + relevel(employment_class_category, ref="hourly"), data = tethered_cord_SSEP_MEP_EMG_demographics, family = "binomial")

summary(tethered_cord_logistic_regression)

exp(cbind(OR=coef(tethered_cord_logistic_regression), confint(tethered_cord_logistic_regression)))
```




Tethered cord monitoring by year
```{r}
# Tethered cord monitoring by year
tethered_cord_monitoring_results_by_year <- tethered_cord_SSEP_MEP_EMG_demographics %>% 
  group_by(year(SVCDATE)) %>% 
  select(SSEP, MEP, EMG, sphincter_EMG) %>% 
  ftable()
tethered_cord_monitoring_results_by_year


tethered_cord_monitoring_results_by_year_database <- tethered_cord_SSEP_MEP_EMG_demographics %>% 
  filter(SVCDATE < as.Date("2023-1-1")) %>% 
  mutate(
    number_any_monitoring = case_when(
      any_monitoring == "monitoring" ~ 1,
      TRUE ~ 0),
    number_SSEP = case_when(
      SSEP == "SSEP" ~ 1,
      TRUE ~ 0),
    number_MEP = case_when(
      MEP == "MEP" ~ 1,
      TRUE ~ 0),
    number_EMG = case_when(
      EMG == "EMG" ~ 1,
      TRUE ~ 0),
    number_sphincter_EMG = case_when(
      sphincter_EMG == "sphincter EMG" ~ 1,
      TRUE ~ 0)    
  ) %>% 
  group_by(year(SVCDATE)) %>% 
  summarize(
    count_any_monitoring = sum(number_any_monitoring),
    proportion_any_monitoring = count_any_monitoring / n(),
    count_SSEP = sum(number_SSEP),
    proportion_SSEP = count_SSEP / n(),
    count_MEP = sum(number_MEP),
    proportion_MEP = count_MEP / n(),
    count_EMG = sum(number_EMG),
    proportion_EMG = count_EMG / n(),
    count_sphincter_EMG = sum(number_sphincter_EMG),
    proportion_sphincter_EMG = count_sphincter_EMG / n(),
    total_patients = n()
  ) %>% 
  collect()
tethered_cord_monitoring_results_by_year_database


# Proportion of patients with monitoring per year figure
tethered_cord_monitoring_results_by_year_plot <- ggplot(data=tethered_cord_monitoring_results_by_year_database) +
  geom_line(aes(x=`year(SVCDATE)`, y=proportion_any_monitoring), lwd=1.5, color="darkgreen") +   
  geom_line(aes(x=`year(SVCDATE)`, y=proportion_SSEP), lwd=1.5, color="red") + 
  geom_line(aes(x=`year(SVCDATE)`, y=proportion_MEP), lwd=1.5, color="blue") + 
  geom_line(aes(x=`year(SVCDATE)`, y=proportion_EMG), lwd=1.5, color="darkorange") + 
  geom_line(aes(x=`year(SVCDATE)`, y=proportion_sphincter_EMG), lwd=1.5, color="darkgray") + 
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2022) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 1, 0.1), limits = c(0, 1))
tethered_cord_monitoring_results_by_year_plot
```








## 7. Repair of thoracoabdominal aortic aneurysm




Identify patients with repair of thoracoabdominal aortic aneurysm
```{r}
# Codes for patients with repair of thoracoabdominal aortic aneurysm
CPT_code_aortic_aneurysm <- c("33877", "33880", "33881", "33883", "33884", "33886", "34703", "34704", "34705", "34706", "34830", "34831", "34832", "35082")




# Patients with repair of thoracoabdominal aortic aneurysm

#################################2006#################################
aortic_aneurysm_2006_s <- ms_s_2006 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_aortic_aneurysm) & (PROCTYP=="1")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2007#################################
aortic_aneurysm_2007_s <- ms_s_2007 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_aortic_aneurysm) & (PROCTYP=="1")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2008#################################
aortic_aneurysm_2008_s <- ms_s_2008 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_aortic_aneurysm) & (PROCTYP=="1")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2009#################################
aortic_aneurysm_2009_s <- ms_s_2009 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_aortic_aneurysm) & (PROCTYP=="1")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2010#################################
aortic_aneurysm_2010_s <- ms_s_2010 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_aortic_aneurysm) & (PROCTYP=="1")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2011#################################
aortic_aneurysm_2011_s <- ms_s_2011 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_aortic_aneurysm) & (PROCTYP=="1")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2012#################################
aortic_aneurysm_2012_s <- ms_s_2012 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_aortic_aneurysm) & (PROCTYP=="1")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2013#################################
aortic_aneurysm_2013_s <- ms_s_2013 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_aortic_aneurysm) & (PROCTYP=="1")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2014#################################
aortic_aneurysm_2014_s <- ms_s_2014 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_aortic_aneurysm) & (PROCTYP=="1")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2015#################################
aortic_aneurysm_2015_s <- ms_s_2015 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_aortic_aneurysm) & (PROCTYP=="1")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2016#################################
aortic_aneurysm_2016_s <- ms_s_2016 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_aortic_aneurysm) & (PROCTYP=="1")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2017#################################
aortic_aneurysm_2017_s <- ms_s_2017 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_aortic_aneurysm) & (PROCTYP=="1")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2018#################################
aortic_aneurysm_2018_s <- ms_s_2018 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_aortic_aneurysm) & (PROCTYP=="1")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2019#################################
aortic_aneurysm_2019_s <- ms_s_2019 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_aortic_aneurysm) & (PROCTYP=="1")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2020#################################
aortic_aneurysm_2020_s <- ms_s_2020 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_aortic_aneurysm) & (PROCTYP=="1")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2021#################################
aortic_aneurysm_2021_s <- ms_s_2021 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_aortic_aneurysm) & (PROCTYP=="1")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2022#################################
aortic_aneurysm_2022_s <- ms_s_2022 %>% 
  select(ENROLID, AGE, SEX, DX1, SVCDATE, PROC1, PROCTYP) %>% 
  filter((PROC1 %in% CPT_code_aortic_aneurysm) & (PROCTYP=="1")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))




# Patients with repair of thoracolumbar aortic aneurysm
aortic_aneurysm <- bind_rows(aortic_aneurysm_2006_s, aortic_aneurysm_2007_s, aortic_aneurysm_2008_s, aortic_aneurysm_2009_s, aortic_aneurysm_2010_s, aortic_aneurysm_2011_s, aortic_aneurysm_2012_s, aortic_aneurysm_2013_s, aortic_aneurysm_2014_s, aortic_aneurysm_2015_s, aortic_aneurysm_2016_s, aortic_aneurysm_2017_s, aortic_aneurysm_2018_s, aortic_aneurysm_2019_s, aortic_aneurysm_2020_s, aortic_aneurysm_2021_s, aortic_aneurysm_2022_s) %>% 
  arrange(ENROLID, SVCDATE) %>% 
  collect()
```




Identify the monitoring of patients with repair of thoracolumbar aortic aneurysm
```{r}
# Codes for monitoring
CPT_code_SSEP <- c("95925", "95926", "95927", "95938")

CPT_code_MEP <- c("95928", "95929", "95939")




# Patients with SSEP or MEP

#################################2006#################################
aortic_aneurysm_SSEP_MEP_2006 <- ms_s_2006 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!aortic_aneurysm_2006_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(aortic_aneurysm_2006_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, SSEP, MEP)
  

#################################2007#################################
aortic_aneurysm_SSEP_MEP_2007 <- ms_s_2007 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!aortic_aneurysm_2007_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(aortic_aneurysm_2007_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, SSEP, MEP)


#################################2008#################################
aortic_aneurysm_SSEP_MEP_2008 <- ms_s_2008 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!aortic_aneurysm_2008_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(aortic_aneurysm_2008_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, SSEP, MEP)


#################################2009#################################
aortic_aneurysm_SSEP_MEP_2009 <- ms_s_2009 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!aortic_aneurysm_2009_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(aortic_aneurysm_2009_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, SSEP, MEP)


#################################2010#################################
aortic_aneurysm_SSEP_MEP_2010 <- ms_s_2010 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!aortic_aneurysm_2010_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(aortic_aneurysm_2010_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, SSEP, MEP)


#################################2011#################################
aortic_aneurysm_SSEP_MEP_2011 <- ms_s_2011 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!aortic_aneurysm_2011_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(aortic_aneurysm_2011_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, SSEP, MEP)


#################################2012#################################
aortic_aneurysm_SSEP_MEP_2012 <- ms_s_2012 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!aortic_aneurysm_2012_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(aortic_aneurysm_2012_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, SSEP, MEP)


#################################2013#################################
aortic_aneurysm_SSEP_MEP_2013 <- ms_s_2013 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!aortic_aneurysm_2013_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(aortic_aneurysm_2013_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, SSEP, MEP)


#################################2014#################################
aortic_aneurysm_SSEP_MEP_2014 <- ms_s_2014 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!aortic_aneurysm_2014_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(aortic_aneurysm_2014_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, SSEP, MEP)


#################################2015#################################
aortic_aneurysm_SSEP_MEP_2015 <- ms_s_2015 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!aortic_aneurysm_2015_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(aortic_aneurysm_2015_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, SSEP, MEP)


#################################2016#################################
aortic_aneurysm_SSEP_MEP_2016 <- ms_s_2016 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!aortic_aneurysm_2016_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(aortic_aneurysm_2016_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, SSEP, MEP)


#################################2017#################################
aortic_aneurysm_SSEP_MEP_2017 <- ms_s_2017 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!aortic_aneurysm_2017_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(aortic_aneurysm_2017_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, SSEP, MEP)


#################################2018#################################
aortic_aneurysm_SSEP_MEP_2018 <- ms_s_2018 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!aortic_aneurysm_2018_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(aortic_aneurysm_2018_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, SSEP, MEP)


#################################2019#################################
aortic_aneurysm_SSEP_MEP_2019 <- ms_s_2019 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!aortic_aneurysm_2019_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(aortic_aneurysm_2019_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, SSEP, MEP)


#################################2020#################################
aortic_aneurysm_SSEP_MEP_2020 <- ms_s_2020 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!aortic_aneurysm_2020_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(aortic_aneurysm_2020_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, SSEP, MEP)


#################################2021#################################
aortic_aneurysm_SSEP_MEP_2021 <- ms_s_2021 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!aortic_aneurysm_2021_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(aortic_aneurysm_2021_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, SSEP, MEP)


#################################2022#################################
aortic_aneurysm_SSEP_MEP_2022 <- ms_s_2022 %>% 
  select(ENROLID, SVCDATE, PROC1, PROCTYP) %>% 
  mutate(across(ENROLID, as.numeric)) %>%
  filter(ENROLID %in% !!aortic_aneurysm_2022_s$ENROLID) %>% 
  filter(((PROC1 %in% CPT_code_SSEP) & (PROCTYP=="1")) | ((PROC1 %in% CPT_code_MEP) & (PROCTYP=="1"))) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  right_join(aortic_aneurysm_2022_s, by=c("ENROLID", "SVCDATE")) %>% 
  group_by(ENROLID, SVCDATE) %>% 
  mutate(SSEP = case_when(
    any((PROC1 %in% CPT_code_SSEP)) ~ "SSEP", 
    TRUE ~ "no SSEP")) %>% 
  mutate(MEP = case_when(
    any((PROC1 %in% CPT_code_MEP)) ~ "MEP", 
    TRUE ~ "No MEP")) %>% 
  ungroup() %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  select(ENROLID, SVCDATE, AGE, SEX, SSEP, MEP)




# Patients with spinal fusion with or without SSEP, MEP, EMG
aortic_aneurysm_SSEP_MEP <- bind_rows(aortic_aneurysm_SSEP_MEP_2006, aortic_aneurysm_SSEP_MEP_2007, aortic_aneurysm_SSEP_MEP_2008, aortic_aneurysm_SSEP_MEP_2009, aortic_aneurysm_SSEP_MEP_2010, aortic_aneurysm_SSEP_MEP_2011, aortic_aneurysm_SSEP_MEP_2012, aortic_aneurysm_SSEP_MEP_2013, aortic_aneurysm_SSEP_MEP_2014, aortic_aneurysm_SSEP_MEP_2015, aortic_aneurysm_SSEP_MEP_2016, aortic_aneurysm_SSEP_MEP_2017, aortic_aneurysm_SSEP_MEP_2018, aortic_aneurysm_SSEP_MEP_2019, aortic_aneurysm_SSEP_MEP_2020, aortic_aneurysm_SSEP_MEP_2021, aortic_aneurysm_SSEP_MEP_2022) %>% 
  arrange(ENROLID, SVCDATE) %>% 
  collect()
```




Aortic aneurysm repair demographics
```{r}
#################################2006#################################
aortic_aneurysm_demographics_2006 <- ms_t_2006 %>% 
  filter(ENROLID %in% !!aortic_aneurysm_SSEP_MEP$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2007#################################
aortic_aneurysm_demographics_2007 <- ms_t_2007 %>% 
  filter(ENROLID %in% !!aortic_aneurysm_SSEP_MEP$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2008#################################
aortic_aneurysm_demographics_2008 <- ms_t_2008 %>% 
  filter(ENROLID %in% !!aortic_aneurysm_SSEP_MEP$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2009#################################
aortic_aneurysm_demographics_2009 <- ms_t_2009 %>% 
  filter(ENROLID %in% !!aortic_aneurysm_SSEP_MEP$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2010#################################
aortic_aneurysm_demographics_2010 <- ms_t_2010 %>% 
  filter(ENROLID %in% !!aortic_aneurysm_SSEP_MEP$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2011#################################
aortic_aneurysm_demographics_2011 <- ms_t_2011 %>% 
  filter(ENROLID %in% !!aortic_aneurysm_SSEP_MEP$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2012#################################
aortic_aneurysm_demographics_2012 <- ms_t_2012 %>% 
  filter(ENROLID %in% !!aortic_aneurysm_SSEP_MEP$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2013#################################
aortic_aneurysm_demographics_2013 <- ms_t_2013 %>% 
  filter(ENROLID %in% !!aortic_aneurysm_SSEP_MEP$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2014#################################
aortic_aneurysm_demographics_2014 <- ms_t_2014 %>% 
  filter(ENROLID %in% !!aortic_aneurysm_SSEP_MEP$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2015#################################
aortic_aneurysm_demographics_2015 <- ms_t_2015 %>% 
  filter(ENROLID %in% !!aortic_aneurysm_SSEP_MEP$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2016#################################
aortic_aneurysm_demographics_2016 <- ms_t_2016 %>% 
  filter(ENROLID %in% !!aortic_aneurysm_SSEP_MEP$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2017#################################
aortic_aneurysm_demographics_2017 <- ms_t_2017 %>% 
  filter(ENROLID %in% !!aortic_aneurysm_SSEP_MEP$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2018#################################
aortic_aneurysm_demographics_2018 <- ms_t_2018 %>% 
  filter(ENROLID %in% !!aortic_aneurysm_SSEP_MEP$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2019#################################
aortic_aneurysm_demographics_2019 <- ms_t_2019 %>% 
  filter(ENROLID %in% !!aortic_aneurysm_SSEP_MEP$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2020#################################
aortic_aneurysm_demographics_2020 <- ms_t_2020 %>% 
  filter(ENROLID %in% !!aortic_aneurysm_SSEP_MEP$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2021#################################
aortic_aneurysm_demographics_2021 <- ms_t_2021 %>% 
  filter(ENROLID %in% !!aortic_aneurysm_SSEP_MEP$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2022#################################
aortic_aneurysm_demographics_2022 <- ms_t_2022 %>% 
  filter(ENROLID %in% !!aortic_aneurysm_SSEP_MEP$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()




# Demographics
aortic_aneurysm_demographics <- bind_rows(aortic_aneurysm_demographics_2006, aortic_aneurysm_demographics_2007, aortic_aneurysm_demographics_2008, aortic_aneurysm_demographics_2009, aortic_aneurysm_demographics_2010, aortic_aneurysm_demographics_2011, aortic_aneurysm_demographics_2012, aortic_aneurysm_demographics_2013, aortic_aneurysm_demographics_2014, aortic_aneurysm_demographics_2015, aortic_aneurysm_demographics_2016, aortic_aneurysm_demographics_2017, aortic_aneurysm_demographics_2018, aortic_aneurysm_demographics_2019, aortic_aneurysm_demographics_2020, aortic_aneurysm_demographics_2021, aortic_aneurysm_demographics_2022) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  arrange(ENROLID, DTSTART) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  select(ENROLID, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, INDSTRY, MSA) %>% 
  collect()
```




Add demographic data to the database
```{r}
# Add demographic data to the database
aortic_aneurysm_SSEP_MEP_demographics <- aortic_aneurysm_SSEP_MEP %>% 
  left_join(aortic_aneurysm_demographics, by="ENROLID") %>% 
  mutate(SSEP = as.factor(SSEP),
         MEP = as.factor(MEP)) %>% 
  mutate(any_monitoring = as.factor(case_when(
    (SSEP == "SSEP" | MEP == "MEP") ~ "monitoring",
    TRUE ~ "no monitoring"))) %>% 
  mutate(male = as.factor(case_when(
  SEX == 1 ~ "yes",
  TRUE ~ "no"))) %>% 
  mutate(year_surgery = case_when(
  (year(SVCDATE) %in% 2006:2011) ~ "2006-2011",
  (year(SVCDATE) %in% 2012:2017) ~ "2012-2017",
  (year(SVCDATE) %in% 2018:2022) ~ "2018-2022")) %>% 
  mutate(rural = as.factor(case_when(
  MSA == 0 ~ "yes",
  TRUE ~ "no"))) %>% 
  mutate(region_category = as.factor(case_when(
  REGION == 1 ~ "Northeast",
  REGION == 2 ~ "North Central",
  REGION == 3 ~ "South",
  REGION == 4 ~ "West",
  TRUE ~ "unknown"))) %>% 
  mutate(employment_status_category = as.factor(case_when(
  EESTATU == 1 ~ "full-time",
  TRUE ~ "other"))) %>% 
  mutate(employment_class_category = as.factor(case_when(
  (EECLASS == 1 | EECLASS == 2 | EECLASS == 3) ~ "salary",
  (EECLASS == 4 | EECLASS == 5 | EECLASS == 6) ~ "hourly",
  TRUE ~ "other"))) %>% 
  mutate(any_monitoring_numeric = case_when(
    any_monitoring == "monitoring" ~ 1,
    TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, any_monitoring, any_monitoring_numeric, AGE, male, year_surgery, rural, region_category, employment_class_category, employment_status_category, SSEP, MEP)
```




Demographics aortic aneurysm
```{r}
# Total surgeries
aortic_aneurysm_total_surgeries <- aortic_aneurysm_SSEP_MEP_demographics %>% 
  nrow()
aortic_aneurysm_total_surgeries


# Total patients
aortic_aneurysm_total_patients <- aortic_aneurysm_SSEP_MEP_demographics %>% 
  distinct(ENROLID) %>% 
  nrow()
aortic_aneurysm_total_patients


# Age
aortic_aneurysm_age <- aortic_aneurysm_SSEP_MEP_demographics %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  summarize(
    median_age = median(AGE),
    p25_age = quantile(AGE, 0.25),
    p75_age = quantile(AGE, 0.75),
    mean_age = mean(AGE),
    SD_age = sd(AGE)
  ) %>% 
  collect()
aortic_aneurysm_age


# Sex
aortic_aneurysm_sex <- aortic_aneurysm_SSEP_MEP_demographics %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  reframe(
  sex = CrossTable(male)
)


# Year surgery
aortic_aneurysm_year_surgery <- aortic_aneurysm_SSEP_MEP_demographics %>% 
  reframe(
  year_surgery = CrossTable(year_surgery)
)


# Rural
aortic_aneurysm_rural <- aortic_aneurysm_SSEP_MEP_demographics %>% 
  reframe(
  rural = CrossTable(rural)
)


# Region
aortic_aneurysm_region <- aortic_aneurysm_SSEP_MEP_demographics %>% 
  reframe(
  region = CrossTable(region_category)
)


# Employment status
aortic_aneurysm_employment_status <- aortic_aneurysm_SSEP_MEP_demographics %>% 
  reframe(
  employment_status = CrossTable(employment_status_category)
)


# Employment class
aortic_aneurysm_employment_class <- aortic_aneurysm_SSEP_MEP_demographics %>% 
  reframe(
  employment_class = CrossTable(employment_class_category)
)
```




Release of aortic aneurysm monitoring
```{r}
# Aortic aneurysm repair monitoring
aortic_aneurysm_monitoring_results <- aortic_aneurysm_SSEP_MEP_demographics %>% 
  select(SSEP, MEP) %>% 
  ftable()
aortic_aneurysm_monitoring_results


# Regression on aortic aneurysm monitoring 
aortic_aneurysm_logistic_regression <- glm(any_monitoring_numeric ~ AGE + male + year_surgery + rural + relevel(region_category, ref="West") + relevel(employment_status_category, ref="other") + relevel(employment_class_category, ref="hourly"), data = aortic_aneurysm_SSEP_MEP_demographics, family = "binomial")

summary(aortic_aneurysm_logistic_regression)

exp(cbind(OR=coef(aortic_aneurysm_logistic_regression), confint(aortic_aneurysm_logistic_regression)))
```




Aortic aneurysm monitoring by year
```{r}
# Aortic aneurysm monitoring by year
aortic_aneurysm_monitoring_results_by_year <- aortic_aneurysm_SSEP_MEP_demographics %>% 
  group_by(year(SVCDATE)) %>% 
  select(SSEP, MEP) %>% 
  ftable()
aortic_aneurysm_monitoring_results_by_year


aortic_aneurysm_monitoring_results_by_year_database <- aortic_aneurysm_SSEP_MEP_demographics %>% 
  filter(SVCDATE < as.Date("2023-1-1")) %>% 
  mutate(
    number_any_monitoring = case_when(
      any_monitoring == "monitoring" ~ 1,
      TRUE ~ 0),
    number_SSEP = case_when(
      SSEP == "SSEP" ~ 1,
      TRUE ~ 0),
    number_MEP = case_when(
      MEP == "MEP" ~ 1,
      TRUE ~ 0)
  ) %>% 
  group_by(year(SVCDATE)) %>% 
  summarize(
    count_any_monitoring = sum(number_any_monitoring),
    proportion_any_monitoring = count_any_monitoring / n(),
    count_SSEP = sum(number_SSEP),
    proportion_SSEP = count_SSEP / n(),
    count_MEP = sum(number_MEP),
    proportion_MEP = count_MEP / n(),
    total_patients = n()
  ) %>% 
  collect()
aortic_aneurysm_monitoring_results_by_year_database


# Proportion of patients with monitoring per year figure
aortic_aneurysm_monitoring_results_by_year_plot <- ggplot(data=aortic_aneurysm_monitoring_results_by_year_database) +
  geom_line(aes(x=`year(SVCDATE)`, y=proportion_any_monitoring), lwd=1.5, color="darkgreen") +   
  geom_line(aes(x=`year(SVCDATE)`, y=proportion_SSEP), lwd=1.5, color="red") + 
  geom_line(aes(x=`year(SVCDATE)`, y=proportion_MEP), lwd=1.5, color="blue") + 
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2022) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 1, 0.1), limits = c(0, 1))
aortic_aneurysm_monitoring_results_by_year_plot
```








## 8. Disconnect from the database




Disconnect from the database
```{r}
# Disconnect
dbDisconnect(MarketScan)
```

